<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8" />
    <title>来料检验记录表</title>
    <style>
        td:not(.except) {
            height: 40px;
            width: 100px;
            text-align: center;
        }

        .except {
            vertical-align: top;
        }

        .classify {
            position: relative;
        }

        .c1,
        .c2,
        .c3 {
            position: absolute;
            width: 100px;
            height: 40px;
            background: #000;
            clip-path: polygon(1% 0, 99% 99%, 100% 100%, 99% 100%, 0 1%, 0 0);
        }

        .c2 {
            height: 80px;
        }

        .c3 {
            width: 80px;
            height: 120px;
        }

        .w1,
        .w2,
        .w3,
        .w4 {
            right: 5px;
            font-size: 12px;
            position: absolute;
        }

        .w1 {
            top: 5px;
        }

        .w2 {
            top: 40px;
        }

        .w3 {
            top: 75px;
        }

        .w4 {
            top: 90px;
            right: 50px;
        }

        .title {
            display: flex;
            justify-content: center;
            font-weight: bold;
            font-size: 24px;
            width: 100%;
        }

        /* 页眉、页脚样式 */
        .header-left {
            position: fixed;
            top: 5px;
            left: 10px;
            font-size: 12px;
        }

        .header-right {
            position: fixed;
            top: 5px;
            right: 10px;
            font-size: 12px;
        }

        .footer-left {
            position: fixed;
            bottom: 10px;
            left: 10px;
            font-size: 12px;
            width: 50%;
        }

        .footer-right {
            position: fixed;
            bottom: 10px;
            right: 10px;
            font-size: 12px;
        }

        body {
            position: relative;
            margin: 100px 20px 80px 20px;
        }

        table {
            border-collapse: collapse;
            width: 100%;
        }

            table td, table th {
                border: 1px solid #000;
                padding: 4px 6px;
                font-size: 13px;
            }

        .toolbar {
            margin: 8px 0 16px 0;
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }

        .small {
            font-size: 12px;
            padding: 6px 8px;
        }

        .link-box {
            margin: 8px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
            word-break: break-all;
            border: 1px solid #ddd;
        }

        .form-group {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        input[type="text"] {
            min-width: 120px;
        }

        .api-input {
            min-width: 300px;
        }

        #emptyPlaceholder {
            text-align: center;
            padding: 40px;
            color: #666;
            font-style: italic;
        }
    </style>
</head>

<body>
    <!-- 页眉 -->
    <div class="header-left">以诺康医疗科技（苏州）股份有限公司</div>
    <div id="headerRight" class="header-right"></div>

    <!-- 工具栏 -->
    <div class="toolbar">
        <div class="form-group">
            <label>DocCode：</label>
            <input id="docCode" type="text" class="small" placeholder="输入文档代码" />
        </div>

        <div class="form-group">
            <label>数据API：</label>
            <input id="fetchUrl" type="text" class="small api-input" value="/api/inspection/GetInspectionRecord?docCode=" />
            <button id="btnFetch" class="small">加载数据</button>
        </div>

        <div class="form-group">
            <label>回写API：</label>
            <input id="callbackUrl" type="text" class="small api-input" value="/api/erp/UpdateReceiveInspectResultYNK" />
            <button id="btnGenLink" class="small">生成链接</button>
            <button id="btnCallApi" class="small">调用API</button>
        </div>

        <button id="btnPrint" class="small">打印</button>
    </div>

    <!-- 生成的API链接显示区域 -->
    <div id="generatedLink" class="link-box" style="display: none;"></div>

    <!-- 主要内容区域 -->
    <div id="recordContainer">
        <div class="title">来料检验记录表</div>

        <div style="width: 100%; display: flex; justify-content: end;">
            编号：<span id="recNoServer"></span>
        </div>

        <div style="width: 100%; display: flex; justify-content: space-between; flex-wrap: wrap;">
            <div>物料名称：<span id="materialNameServer"></span></div>
            <div>物料编号：<span id="materialCodeServer"></span></div>
            <div>来料批次：<span id="batchNoServer"></span></div>
            <div>来料数量：<span id="qtyServer"></span></div>
        </div>

        <!-- 表格区域 -->
        <div id="tableArea" style="margin-top: 12px;">
            <div id="emptyPlaceholder">请填写 DocCode 并点击"加载数据"来显示检验记录。</div>
        </div>
    </div>

    <!-- 页脚 -->
    <div class="footer-left">
        注：1. 评判项，合格的打 "√"，不合格的打 "×"。2. 根据抽样数量可自行添加样本号。<br>
        加密等级：机密
    </div>
    <div class="footer-right">
        表单格式生效日期：<span id="effectiveDateServer"></span>
    </div>

    <script>
        function createCell(tag, text, attrs = {}) {
            const el = document.createElement(tag);
            el.innerText = text || "";
            Object.keys(attrs).forEach(key => el.setAttribute(key, attrs[key]));
            return el;
        }

        // 构建表格
        function buildTableFromData(data) {
            const table = document.createElement('table');
            table.border = "1";
            table.cellSpacing = "0";

            // 第一行 - 样本号
            const tr1 = document.createElement('tr');
            const tdClassify = createCell('td', '', {
                'class': 'except',
                'rowspan': '3'
            });
            tdClassify.innerHTML = `
                <div class="classify">
                    <div class="c1"></div>
                    <div class="c2"></div>
                    <div class="c3"></div>
                    <div class="w1">序号</div>
                    <div class="w2">项目</div>
                    <div class="w3">设备<br>编号</div>
                    <div class="w4">样本号</div>
                </div>
            `;
            tr1.appendChild(tdClassify);

            // 添加样本号单元格
            data.SampleNos.forEach(sampleNo => {
                tr1.appendChild(createCell('td', sampleNo));
            });
            tr1.appendChild(createCell('td', '评判', { 'rowspan': '3' }));
            table.appendChild(tr1);

            // 第二行 - 项目
            const tr2 = document.createElement('tr');
            data.Item.forEach(item => {
                tr2.appendChild(createCell('td', item));
            });
            table.appendChild(tr2);

            // 第三行 - 设备编号
            const tr3 = document.createElement('tr');
            data.DeviceID.forEach(deviceId => {
                tr3.appendChild(createCell('td', `ME ${deviceId}`));
            });
            table.appendChild(tr3);

            // 数据行
            data.TableRows.forEach(row => {
                const tr = document.createElement('tr');
                tr.appendChild(createCell('td', row.RowIndex));

                row.Cells.forEach(cell => {
                    tr.appendChild(createCell('td', cell));
                });

                table.appendChild(tr);
            });

            // 检验结果行
            const trResult = document.createElement('tr');
            trResult.appendChild(createCell('td', '检验结果'));
            const tdResult = createCell('td', data.InspectionResult, { 'colspan': '14' });
            trResult.appendChild(tdResult);
            table.appendChild(trResult);

            // 备注行
            const trRemark = document.createElement('tr');
            trRemark.appendChild(createCell('td', '备注'));
            const tdRemark = createCell('td', data.Remark, { 'colspan': '14' });
            trRemark.appendChild(tdRemark);
            table.appendChild(trRemark);

            // 签名行
            const trSign = document.createElement('tr');
            const tdSign = createCell('td', '', {
                'colspan': '15',
                'style': 'text-align: left;'
            });
            tdSign.innerHTML = `
                <span style="margin-right: 100px;">检验人员：${data.Inspector}</span>
                <span style="margin-right: 500px;">日期：${data.InspectorDate}</span>
                <span style="margin-right: 100px;">复核人员：${data.Reviewer}</span>
                <span>日期：${data.ReviewerDate}</span>
            `;
            trSign.appendChild(tdSign);
            table.appendChild(trSign);

            return table;
        }

        // 加载数据
        async function loadData() {
            const docCode = document.getElementById('docCode').value.trim();
            if (!docCode) {
                alert('请输入 DocCode');
                return;
            }

            let fetchUrl = document.getElementById('fetchUrl').value.trim();
            if (!fetchUrl.includes('?')) {
                fetchUrl += '?docCode=' + encodeURIComponent(docCode);
            } else {
                fetchUrl += '&docCode=' + encodeURIComponent(docCode);
            }

            try {
                const response = await fetch(fetchUrl);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                const data = result.data || result; // 适应不同的API响应格式

                renderData(data);
            } catch (error) {
                console.error('加载数据失败:', error);
                alert('加载数据失败: ' + error.message);
            }
        }

        // 渲染数据到页面
        function renderData(data) {
            // 更新基本信息
            document.getElementById('headerRight').textContent = data.FormCode || '';
            document.getElementById('recNoServer').textContent = data.RecordNo || '';
            document.getElementById('materialNameServer').textContent = data.MaterialName || '';
            document.getElementById('materialCodeServer').textContent = data.MaterialCode || '';
            document.getElementById('batchNoServer').textContent = data.BatchNo || '';
            document.getElementById('qtyServer').textContent = data.Qty || '';
            document.getElementById('effectiveDateServer').textContent = data.EffectiveDate || '';

            // 构建并显示表格
            const tableArea = document.getElementById('tableArea');
            tableArea.innerHTML = '';
            const table = buildTableFromData(data);
            tableArea.appendChild(table);

            // 保存数据用于后续API调用
            window.currentData = data;
        }

        // 生成API链接
        function generateApiLink() {
            const callbackUrl = document.getElementById('callbackUrl').value.trim();
            if (!callbackUrl) {
                alert('请输入回写API地址');
                return;
            }

            if (!window.currentData) {
                alert('请先加载数据');
                return;
            }

            const docCode = document.getElementById('docCode').value.trim();
            const separator = callbackUrl.includes('?') ? '&' : '?';
            const apiLink = `${callbackUrl}${separator}docCode=${encodeURIComponent(docCode)}`;

            const linkBox = document.getElementById('generatedLink');
            linkBox.style.display = 'block';
            linkBox.innerHTML = `
                <strong>API调用链接：</strong><br>
                <a href="${apiLink}" target="_blank">${apiLink}</a>
                <button onclick="copyToClipboard('${apiLink}')" class="small" style="margin-left: 10px;">复制链接</button>
            `;
        }

        // 直接调用API
        async function callApiDirectly() {
            const callbackUrl = document.getElementById('callbackUrl').value.trim();
            if (!callbackUrl) {
                alert('请输入回写API地址');
                return;
            }

            if (!window.currentData) {
                alert('请先加载数据');
                return;
            }

            try {
                const response = await fetch(callbackUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(window.currentData)
                });

                if (response.ok) {
                    alert('API调用成功');
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                console.error('API调用失败:', error);
                alert('API调用失败: ' + error.message);
            }
        }

        // 复制到剪贴板
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('已复制到剪贴板');
            }).catch(() => {
                // 降级方案
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('已复制到剪贴板');
            });
        }

        // 打印功能
        function printPage() {
            window.print();
        }

        // 事件监听
        document.getElementById('btnFetch').addEventListener('click', loadData);
        document.getElementById('btnGenLink').addEventListener('click', generateApiLink);
        document.getElementById('btnCallApi').addEventListener('click', callApiDirectly);
        document.getElementById('btnPrint').addEventListener('click', printPage);

        // 支持按Enter键加载数据
        document.getElementById('docCode').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                loadData();
            }
        });

        // 页面加载时尝试从URL参数获取docCode
        window.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const docCodeFromUrl = urlParams.get('docCode');
            if (docCodeFromUrl) {
                document.getElementById('docCode').value = docCodeFromUrl;
                // 可选：自动加载数据
                // loadData();
            }
        });
    </script>
</body>
</html>