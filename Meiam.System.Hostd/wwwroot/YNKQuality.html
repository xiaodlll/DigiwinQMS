<!DOCTYPE html>
<html>
<head>
    <title>质量看板</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style type="text/css">
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Microsoft YaHei', sans-serif;
        }

        body {
            background: #f5f7fa;
            padding: 20px;
        }

        .title {
            display: flex;
            font-size: 24px;
            font-weight: bold;
            width: 100%;
            justify-content: center;
            margin-bottom: 20px;
            color: #333;
        }

        .container {
            width: 100%;
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            padding: 0 20px;
        }

        /* 物料类型选择器 */
        .material-type-selector {
            width: 100%;
            margin-bottom: 20px;
            padding: 0 20px;
        }

        .btn-group {
            display: flex;
            border-radius: 4px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .btn {
            padding: 8px 16px;
            background: #f0f2f5;
            border: none;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            color: #333;
        }

            .btn:hover {
                background: #e1e5eb;
            }

            .btn.active {
                background: #409eff;
                color: white;
            }

        .btn-primary {
            background: #409eff;
            color: white;
            padding: 10px 20px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

            .btn-primary:hover {
                background: #337ecc;
            }

        /* 顶部统计卡片 */
        .stats-container {
            width: 100%;
            padding: 0;
            list-style-type: none;
            display: inline-flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }

            .stats-container li {
                border: 1px solid #000;
                padding: 20px 24px;
                display: flex;
                justify-content: center;
                align-items: center;
                font-size: 18px;
                font-weight: bold;
                border-radius: 10px;
                cursor: pointer;
                transition: all 0.3s;
                min-width: 150px;
                text-align: center;
                flex: 1;
                margin: 0 5px;
            }

                .stats-container li:hover {
                    transform: translateY(-2px);
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                }

                .stats-container li:nth-child(1) {
                    background: rgba(26, 188, 156, .1);
                    color: #1abc9c;
                    border-color: #1abc9c;
                }

                .stats-container li:nth-child(2) {
                    background: rgba(52, 152, 219, .1);
                    color: #3498db;
                    border-color: #3498db;
                }

                .stats-container li:nth-child(3) {
                    background: rgba(155, 89, 182, .1);
                    color: #9b59b6;
                    border-color: #9b59b6;
                }

                .stats-container li:nth-child(4) {
                    background: rgba(241, 196, 15, .1);
                    color: #f1c40f;
                    border-color: #f1c40f;
                }

                .stats-container li:nth-child(5) {
                    background: rgba(231, 76, 60, .1);
                    color: #e74c3c;
                    border-color: #e74c3c;
                }

                .stats-container li:nth-child(6) {
                    background: rgba(52, 73, 94, .1);
                    color: #34495e;
                    border-color: #34495e;
                }

                .stats-container li.inspection-delay {
                    /*display: flex !important;*/
                }

        .line-title {
            padding-left: 12px;
            display: flex;
            align-items: center;
            width: 100%;
            font-size: 16px;
            font-weight: bold;
            margin-top: 20px;
            margin-bottom: 12px;
            border-left: 3px solid #2980b9;
        }

        /* 图表容器样式 */
        .chart-container {
            width: calc(50% - 5px);
            height: 600px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
            padding: 15px;
            display: flex;
            flex-direction: column;
            margin-bottom: 10px;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .chart-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }

        .chart-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .date-range-picker {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        .date-input {
            padding: 6px 10px;
            border: 1px solid #dcdfe6;
            border-radius: 4px;
            font-size: 14px;
            width: 130px;
        }

        .project-selector, .material-selector {
            position: relative;
        }

        .selector-btn {
            padding: 6px 12px;
            background: #f0f2f5;
            border: 1px solid #dcdfe6;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .selector-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            background: white;
            border: 1px solid #dcdfe6;
            border-radius: 4px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
            padding: 10px;
            z-index: 100;
            width: 200px;
            display: none;
        }

        .selector-option {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }

            .selector-option input {
                margin-right: 8px;
            }

        .chart-content {
            flex: 1;
            width: 100%;
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            font-size: 16px;
            color: #666;
        }

        .hidden {
            display: none !important;
        }

        /* 供应商质量排行样式 - 根据图片设计 */
        .supplier-rank-container {
            width: 100%;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
        }

        .supplier-rank-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .supplier-rank-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

            .supplier-rank-title i {
                color: #409eff;
            }

        .supplier-rank-content {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .supplier-rank-block {
            border: 1px solid #e4e7ed;
            border-radius: 6px;
            padding: 15px;
            background: white;
        }

        .supplier-rank-block-title {
            font-size: 14px;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 1px solid #f0f0f0;
        }

        .supplier-list {
            list-style: none;
        }

        .supplier-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px dashed #f0f0f0;
            cursor: pointer;
            transition: all 0.3s;
        }

            .supplier-item:hover {
                background: #f5f7fa;
            }

            .supplier-item:last-child {
                border-bottom: none;
            }

        .supplier-rank-number {
            font-size: 14px;
            color: #666;
            margin-right: 8px;
            min-width: 20px;
        }

        .supplier-name {
            font-size: 14px;
            color: #333;
            flex: 1;
            cursor: pointer;
        }

            .supplier-name:hover {
                color: #409eff;
                text-decoration: underline;
            }

        .supplier-value {
            font-size: 14px;
            color: #333;
        }

            .supplier-value.defect-rate {
                color: #e74c3c;
                font-weight: 600;
            }

            .supplier-value.incoming-batches {
                color: #3498db;
                font-weight: 600;
            }

            .supplier-value.reject-batches {
                color: #f39c12;
                font-weight: 600;
            }

        .data-source-note {
            font-size: 12px;
            color: #999;
            margin-top: 10px;
            padding: 8px;
            background: #f9f9f9;
            border-radius: 4px;
            border-left: 3px solid #409eff;
        }

            .data-source-note i {
                margin-right: 5px;
            }

        .show-all-btn {
            text-align: center;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px dashed #e4e7ed;
        }

        .material-name {
            color: #333;
        }

        .supplier-name-cell {
            color: #606266;
            cursor: pointer;
        }

            .supplier-name-cell:hover {
                color: #409eff;
                text-decoration: underline;
            }

        .defect-type {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }

            .defect-type.appearance {
                background: #fff3cd;
                color: #856404;
                border: 1px solid #ffeaa7;
            }

            .defect-type.dimension {
                background: #d1ecf1;
                color: #0c5460;
                border: 1px solid #bee5eb;
            }

            .defect-type.performance {
                background: #f8d7da;
                color: #721c24;
                border: 1px solid #f5c6cb;
            }

            .defect-type.material {
                background: #d4edda;
                color: #155724;
                border: 1px solid #c3e6cb;
            }

        .discovery-date {
            color: #606266;
        }

        .priority {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }

            .priority.high {
                background: #f8d7da;
                color: #721c24;
                border: 1px solid #f5c6cb;
            }

            .priority.medium {
                background: #fff3cd;
                color: #856404;
                border: 1px solid #ffeaa7;
            }

            .priority.low {
                background: #d1ecf1;
                color: #0c5460;
                border: 1px solid #bee5eb;
            }

        .action-btn {
            padding: 6px 12px;
            background: #409eff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }

            .action-btn:hover {
                background: #337ecc;
            }

        /* 统计详情模态框样式 */
        .stat-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

            .stat-modal.active {
                display: flex;
            }

        .stat-modal-content {
            background: white;
            border-radius: 8px;
            width: 90%;
            max-width: 1000px;
            max-height: 80vh;
            overflow: auto;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }

        .stat-modal-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .stat-modal-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }

        .stat-modal-close {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #999;
        }

            .stat-modal-close:hover {
                color: #333;
            }

        .stat-modal-body {
            padding: 20px;
        }

        /* 模态框样式 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

            .modal.active {
                display: flex;
            }

        .modal-content {
            background: white;
            border-radius: 8px;
            width: 90%;
            max-width: 1000px;
            max-height: 80vh;
            overflow: auto;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #999;
        }

            .modal-close:hover {
                color: #333;
            }

        .modal-body {
            padding: 20px;
        }

            .modal-body table {
                width: 100%;
                border-collapse: collapse;
                margin-bottom: 20px;
            }

            .modal-body th {
                background: #f5f5f5;
                font-weight: 600;
                position: sticky;
                top: 0;
                z-index: 10;
            }

            .modal-body tr:hover {
                background: #f0f7ff !important;
            }

        .modal-body {
            max-height: 70vh;
            overflow-y: auto;
        }

        /* 响应式调整 */
        @media (max-width: 1200px) {
            .supplier-rank-content {
                grid-template-columns: repeat(2, 1fr);
            }

            .chart-container {
                width: 100%;
            }
        }

        @media (max-width: 768px) {
            .supplier-rank-content {
                grid-template-columns: 1fr;
            }

            .stats-container {
                flex-wrap: wrap;
            }

                .stats-container li {
                    min-width: calc(50% - 10px);
                    margin-bottom: 10px;
                }
        }
    </style>
</head>
<body>
    <div class="title">
        质量看板
    </div>

    <!-- 物料类型选择器 -->
    <div class="material-type-selector">
        <div class="btn-group">
            <button class="btn active" id="mass-production-btn">量产类物料</button>
            <button class="btn" id="rd-btn">研发类物料</button>
        </div>
    </div>

    <div class="container">
        <ul class="stats-container">
            <li id="verified-qty" data-type="VerifiedQty">已检验数量：0</li>
            <li id="pending-inspection" data-type="PendingInspectionQty">物料待检验数量：0</li>
            <li id="awaiting-disposition" data-type="QtyAwaitingDisposition">待判定数量：0</li>
            <li id="pending-maintenance" data-type="PendingMaterialMaintenance">物料待维护数量：0</li>
            <li id="monthly-rejections" data-type="MonthlyLotRejections">当月批退数：0</li>
            <li id="inspection-delay" class="inspection-delay" data-type="InspectionDelay">检验延时：0</li>
        </ul>

        <!-- 年累计进料/累计合格率 -->
        <div class="chart-container">
            <div class="chart-header">
                <div class="chart-title">年累计进料/累计合格率</div>
                <div class="chart-controls">
                    <div class="btn-group">
                        <button class="btn active" data-chart="yearComingQualified" data-type="year">年</button>
                    </div>
                </div>
            </div>
            <div id="yearComingQualified" class="chart-content">
                <div class="loading">加载中...</div>
            </div>
        </div>

        <!-- 累计进料/累计合格率 -->
        <div class="chart-container">
            <div class="chart-header">
                <div class="chart-title">累计进料/累计合格率</div>
                <div class="chart-controls">
                    <div class="project-selector">
                        <button class="selector-btn" id="comingQualified-project-btn">
                            选择项目 ▼
                        </button>
                        <div class="selector-dropdown" id="comingQualified-project-dropdown">
                            <!-- 项目选项将通过JS动态生成 -->
                        </div>
                    </div>
                    <div class="btn-group">
                        <button class="btn active" data-chart="comingQualified" data-type="day">日</button>
                        <button class="btn" data-chart="comingQualified" data-type="week">周</button>
                        <button class="btn" data-chart="comingQualified" data-type="month">月</button>
                        <button class="btn" data-chart="comingQualified" data-type="custom">自定义</button>
                    </div>
                </div>
            </div>
            <div class="date-range-picker hidden" id="comingQualified-date-picker">
                <input type="text" class="date-input" id="comingQualified-start-date" placeholder="开始日期">
                <span>至</span>
                <input type="text" class="date-input" id="comingQualified-end-date" placeholder="结束日期">
                <button class="btn" id="comingQualified-apply">应用</button>
            </div>
            <div id="comingQualified" class="chart-content">
                <div class="loading">加载中...</div>
            </div>
        </div>

        <!-- 年累计进料（按项目） -->
        <div class="chart-container">
            <div class="chart-header">
                <div class="chart-title">年累计进料（按项目）</div>
                <div class="chart-controls">
                    <div class="project-selector">
                        <button class="selector-btn" id="yearComingProject-btn">
                            选择项目 ▼
                        </button>
                        <div class="selector-dropdown" id="yearComingProject-dropdown">
                            <!-- 项目选项将通过JS动态生成 -->
                        </div>
                    </div>
                    <div class="btn-group">
                        <button class="btn active" data-chart="yearComingProject" data-type="year">年</button>
                    </div>
                </div>
            </div>
            <div id="yearComingProject" class="chart-content">
                <div class="loading">加载中...</div>
            </div>
        </div>

        <!-- 累计进料/累计合格率（按项目） -->
        <div class="chart-container">
            <div class="chart-header">
                <div class="chart-title">累计进料/累计合格率（按项目）</div>
                <div class="chart-controls">
                    <div class="project-selector">
                        <button class="selector-btn" id="comingProject-btn">
                            选择项目 ▼
                        </button>
                        <div class="selector-dropdown" id="comingProject-dropdown">
                            <!-- 项目选项将通过JS动态生成 -->
                        </div>
                    </div>
                    <div class="btn-group">
                        <button class="btn active" data-chart="comingProject" data-type="day">日</button>
                        <button class="btn" data-chart="comingProject" data-type="week">周</button>
                        <button class="btn" data-chart="comingProject" data-type="month">月</button>
                        <button class="btn" data-chart="comingProject" data-type="custom">自定义</button>
                    </div>
                </div>
            </div>
            <div class="date-range-picker hidden" id="comingProject-date-picker">
                <input type="text" class="date-input" id="comingProject-start-date" placeholder="开始日期">
                <span>至</span>
                <input type="text" class="date-input" id="comingProject-end-date" placeholder="结束日期">
                <button class="btn" id="comingProject-apply">应用</button>
            </div>
            <div id="comingProject" class="chart-content">
                <div class="loading">加载中...</div>
            </div>
        </div>

        <!-- 供应商质量排行 -->
        <div class="supplier-rank-container">
            <div class="supplier-rank-header">
                <div class="supplier-rank-title">
                    <i class="fas fa-trophy"></i>
                    供应商质量排行
                </div>
                <div class="chart-controls">
                    <div class="project-selector">
                        <button class="selector-btn" id="supplier-rank-project-btn">
                            选择项目 ▼
                        </button>
                        <div class="selector-dropdown" id="supplier-rank-project-dropdown">
                            <!-- 项目选项将通过JS动态生成 -->
                        </div>
                    </div>
                    <div class="btn-group">
                        <button class="btn active" data-chart="supplierRank" data-type="day">日</button>
                        <button class="btn" data-chart="supplierRank" data-type="week">周</button>
                        <button class="btn" data-chart="supplierRank" data-type="month">月</button>
                        <button class="btn" data-chart="supplierRank" data-type="custom">自定义</button>
                    </div>
                </div>
            </div>

            <div class="date-range-picker hidden" id="supplier-rank-date-picker">
                <input type="text" class="date-input" id="supplier-rank-start-date" placeholder="开始日期">
                <span>至</span>
                <input type="text" class="date-input" id="supplier-rank-end-date" placeholder="结束日期">
                <button class="btn" id="supplier-rank-apply">应用</button>
            </div>

            <!-- 数据来源说明 -->
            <div class="data-source-note" id="supplier-data-note">
                <i class="fas fa-info-circle"></i>
                <span>显示最近7日/周/月数据或自定义数据</span>
            </div>

            <div class="supplier-rank-content">
                <!-- 供应商名称 -->
                <div class="supplier-rank-block">
                    <div class="supplier-rank-block-title">供应商名称</div>
                    <ul class="supplier-list" id="supplier-name-list">
                        <!-- 供应商名称数据将通过JS动态生成 -->
                    </ul>
                </div>

                <!-- 不良率 -->
                <div class="supplier-rank-block">
                    <div class="supplier-rank-block-title">不良率</div>
                    <ul class="supplier-list" id="defect-rate-list">
                        <!-- 不良率数据将通过JS动态生成 -->
                    </ul>
                </div>

                <!-- 进料批数 -->
                <div class="supplier-rank-block">
                    <div class="supplier-rank-block-title">进料批数</div>
                    <ul class="supplier-list" id="incoming-batches-list">
                        <!-- 进料批数数据将通过JS动态生成 -->
                    </ul>
                </div>

                <!-- 批退批数 -->
                <div class="supplier-rank-block">
                    <div class="supplier-rank-block-title">批退批数</div>
                    <ul class="supplier-list" id="reject-batches-list">
                        <!-- 批退批数数据将通过JS动态生成 -->
                    </ul>
                </div>
            </div>

            <div class="show-all-btn">
                <button class="btn-primary" id="show-all-suppliers-btn">
                    <i class="fas fa-list"></i>
                    显示全部供应商批退率数据
                </button>
            </div>
        </div>
    </div>

    <!-- 统计详情模态框 -->
    <div class="stat-modal" id="stat-detail-modal">
        <div class="stat-modal-content">
            <div class="stat-modal-header">
                <div class="stat-modal-title" id="stat-detail-title">统计详情</div>
                <button class="stat-modal-close" id="stat-modal-close">&times;</button>
            </div>
            <div class="stat-modal-body" id="stat-detail-content">
                <div class="loading">加载中...</div>
            </div>
        </div>
    </div>

    <!-- 供应商详情模态框 -->
    <div class="modal" id="supplier-detail-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">供应商详情</div>
                <button class="modal-close" id="supplier-modal-close">&times;</button>
            </div>
            <div class="modal-body" id="supplier-detail-content">
                <!-- 供应商详情内容将通过JS动态生成 -->
            </div>
        </div>
    </div>

    <!-- 全部供应商模态框 -->
    <div class="modal" id="all-suppliers-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">全部供应商批退率数据</div>
                <button class="modal-close" id="all-suppliers-modal-close">&times;</button>
            </div>
            <div class="modal-body" id="all-suppliers-content">
                <!-- 全部供应商内容将通过JS动态生成 -->
            </div>
        </div>
    </div>
</body>

<script type="text/javascript">
    // 全局状态
    const viewState = {
        materialType: 'massProduction', // massProduction 或 rd
        selectedProjects: [], // 选中的项目

        // 统计卡片数据
        stats: {
            verifiedQty: 0,
            pendingInspection: 0,
            awaitingDisposition: 0,
            pendingMaintenance: 0,
            monthlyRejections: 0,
            inspectionDelay: 0
        },

        // 图表状态
        yearComingQualified: {
            type: 'year'
        },
        comingQualified: {
            type: 'day',
            startDate: null,
            endDate: null,
            projects: []
        },
        yearComingProject: {
            type: 'year',
            projects: []
        },
        comingProject: {
            type: 'day',
            startDate: null,
            endDate: null,
            projects: []
        },

        // 供应商排行状态
        supplierRank: {
            type: 'day',
            startDate: null,
            endDate: null,
            projects: []
        },

        // 当前选中的统计类型
        currentStatType: ''
    };

    // 项目选项配置
    const projectOptions = {
        massProduction: ['超乳', '超声刀', '电刀', '通用'],
        rd: ['机器人', '骨刀', '通用']
    };

    // 初始化ECharts实例
    const charts = {
        yearComingQualified: echarts.init(document.getElementById('yearComingQualified')),
        comingQualified: echarts.init(document.getElementById('comingQualified')),
        yearComingProject: echarts.init(document.getElementById('yearComingProject')),
        comingProject: echarts.init(document.getElementById('comingProject'))
    };

    // 初始化日期选择器
    function initDatePickers() {
        // 累计进料/累计合格率日期选择器
        flatpickr("#comingQualified-start-date", {
            dateFormat: "Y-m-d",
            onChange: function (selectedDates, dateStr) {
                viewState.comingQualified.startDate = dateStr;
            }
        });

        flatpickr("#comingQualified-end-date", {
            dateFormat: "Y-m-d",
            onChange: function (selectedDates, dateStr) {
                viewState.comingQualified.endDate = dateStr;
            }
        });

        // 累计进料/累计合格率（按项目）日期选择器
        flatpickr("#comingProject-start-date", {
            dateFormat: "Y-m-d",
            onChange: function (selectedDates, dateStr) {
                viewState.comingProject.startDate = dateStr;
            }
        });

        flatpickr("#comingProject-end-date", {
            dateFormat: "Y-m-d",
            onChange: function (selectedDates, dateStr) {
                viewState.comingProject.endDate = dateStr;
            }
        });

        // 供应商排行日期选择器
        flatpickr("#supplier-rank-start-date", {
            dateFormat: "Y-m-d",
            onChange: function (selectedDates, dateStr) {
                viewState.supplierRank.startDate = dateStr;
            }
        });

        flatpickr("#supplier-rank-end-date", {
            dateFormat: "Y-m-d",
            onChange: function (selectedDates, dateStr) {
                viewState.supplierRank.endDate = dateStr;
            }
        });
    }

    // 设置默认日期范围
    function setDefaultDateRange() {
        const endDate = new Date();
        const startDate = new Date();

        // 根据类型设置不同的默认范围
        const setRange = (days) => {
            const start = new Date();
            start.setDate(start.getDate() - days);

            return {
                start: start.toISOString().split('T')[0],
                end: endDate.toISOString().split('T')[0]
            };
        };

        // 设置默认值
        const dayRange = setRange(1);
        const weekRange = setRange(7);
        const monthRange = setRange(30);

        // 更新输入框
        document.getElementById('comingQualified-start-date').value = dayRange.start;
        document.getElementById('comingQualified-end-date').value = dayRange.end;

        document.getElementById('comingProject-start-date').value = dayRange.start;
        document.getElementById('comingProject-end-date').value = dayRange.end;

        document.getElementById('supplier-rank-start-date').value = monthRange.start;
        document.getElementById('supplier-rank-end-date').value = monthRange.end;

        // 更新状态
        viewState.comingQualified.startDate = dayRange.start;
        viewState.comingQualified.endDate = dayRange.end;

        viewState.comingProject.startDate = dayRange.start;
        viewState.comingProject.endDate = dayRange.end;

        viewState.supplierRank.startDate = monthRange.start;
        viewState.supplierRank.endDate = monthRange.end;
    }

    // 获取数据的函数
    async function fetchData(url, params) {
        const urlBase = url;

        try {
            const response = await fetch(urlBase, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    MaterialType: params.MaterialType || "",
                    CardType: params.CardType || "",
                    SumType: params.SumType || params.type || "",
                    StartDate: params.StartDate || params.startDate || "",
                    EndDate: params.EndDate || params.endDate || "",
                    MeterialNames: params.materials || "",
                    SuppID: params.SuppID || ""
                }),
                credentials: 'same-origin'
            });

            if (!response.ok) {
                // 提示并尝试显示后端返回的错误信息
                let txt = await response.text();
                throw new Error(`HTTP ${response.status}: ${response.statusText}  ${txt}`);
            }

            let result = await response.json();

            // 后端返回 ApiResponse { Success, Message, Data }
            // 兼容不同命名：Data / data
            let payload = result.Data ?? result.data ?? result;
            // 如果 Data 是字符串（JSON 字符串），尝试解析
            if (typeof payload === 'string') {
                try {
                    payload = JSON.parse(payload);
                } catch (e) {
                    console.warn('解析数据字符串失败:', e);
                }
            }

            if (!payload) {
                console.warn('接口返回为空数据');
                return null;
            }

            return payload;

        } catch (error) {
            console.error('加载数据失败:', error);
            alert('加载数据失败: ' + (error.message || error));
            return null;
        }
    }

    // 从GetIQCTotalDataAsync接口加载统计卡片数据
    async function loadStatsData() {
        try {
            // 根据物料类型确定参数值
            //1：量产2：研发
            let materialTypeParam = 1; // 默认量产类物料
            if (viewState.materialType === 'massProduction') {
                materialTypeParam = 1;
            } else if (viewState.materialType === 'rd') {
                materialTypeParam = 2;
            }
            const params = {
                MaterialType: materialTypeParam
            };
            const data = await fetchData('/api/erp/GetIQCTotalData', params);

            if (data && Array.isArray(data)) {
                // 清除原有的统计卡片文本
                document.querySelectorAll('.stats-container li').forEach(li => {
                    const baseText = li.textContent.split('：')[0];
                    li.textContent = `${baseText}：0`;
                });
                // 遍历API返回的数据
                data.forEach(item => {
                    // 根据name找到对应的统计卡片
                    const cardElement = document.querySelector(`.stats-container li[data-type="${item.name}"]`);
                    if (cardElement) {
                        const baseText = cardElement.textContent.split('：')[0];
                        cardElement.textContent = `${baseText}：${item.value}`;

                        // 更新全局状态
                        const statKey = item.name.charAt(0).toLowerCase() + item.name.slice(1);
                        if (viewState.stats.hasOwnProperty(statKey)) {
                            viewState.stats[statKey] = item.value;
                        }
                    }
                });

                console.log('统计数据已更新:', viewState.stats);
            } else {
                console.warn('API返回的数据格式不正确:', data);

                // 显示默认值
                document.querySelectorAll('.stats-container li').forEach(li => {
                    const text = li.textContent.split('：')[0];
                    li.textContent = `${text}：0`;
                });
            }
        } catch (error) {
            console.error('加载统计数据失败:', error);
            // 显示默认值
            document.querySelectorAll('.stats-container li').forEach(li => {
                const text = li.textContent.split('：')[0];
                li.textContent = `${text}：0`;
            });
        }
    }

    // 从GetIQCDetailDataAsync接口加载统计详情数据
    async function loadStatDetail(statType) {
        try {
            // 根据物料类型确定参数值
            //1：量产2：研发
            let materialTypeParam = 1; // 默认量产类物料
            if (viewState.materialType === 'massProduction') {
                materialTypeParam = 1;
            } else if (viewState.materialType === 'rd') {
                materialTypeParam = 2;
            }
            const params = {
                MaterialType: materialTypeParam,
                CardType: statType
            };
            const data = await fetchData('/api/erp/GetIQCDetailData', params);

            return data;

        } catch (error) {
            console.error('加载统计详情失败:', error);
            return null;
        }
    }

    // 显示统计详情模态框
    async function showStatDetail(statType, statName) {
        const modal = document.getElementById('stat-detail-modal');
        const title = document.getElementById('stat-detail-title');
        const content = document.getElementById('stat-detail-content');

        // 设置标题
        title.textContent = `${statName}详情`;
        viewState.currentStatType = statType;

        // 显示加载状态
        content.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> 加载中...</div>';
        modal.classList.add('active');

        // 加载数据
        const detailData = await loadStatDetail(statType);

        // 渲染数据
        if (detailData) {
            renderStatDetailContent(statType, statName, detailData, content);
        } else {
            content.innerHTML = `
            <div style="padding: 40px; text-align: center;">
                <i class="fas fa-exclamation-triangle" style="font-size: 48px; color: #f39c12; margin-bottom: 15px;"></i>
                <p style="color: #666; margin-bottom: 10px;">数据加载失败</p>
                <p style="color: #999; font-size: 14px;">请检查网络连接或稍后重试</p>
            </div>
        `;
        }
    }

    // 渲染统计详情内容
    function renderStatDetailContent(statType, statName, detailData, contentElement) {
        let html = '';

        // 检查数据格式
        if (!detailData || !Array.isArray(detailData)) {
            html = `
            <div style="padding: 20px; background: #f5f7fa; border-radius: 6px;">
                <p style="color: #666; text-align: center;">暂无数据</p>
            </div>
        `;
            contentElement.innerHTML = html;
            return;
        }

        // 根据统计类型显示不同的标题和统计信息
        let totalCount = detailData.length;
        let additionalInfo = '';

        switch (statType) {
            case 'VerifiedQty':
                additionalInfo = `已检验总数：${totalCount}`;
                break;
            case 'PendingInspectionQty':
                additionalInfo = `待检验总数：${totalCount}`;
                break;
            case 'QtyAwaitingDisposition':
                additionalInfo = `待判定总数：${totalCount}`;
                break;
            case 'PendingMaterialMaintenance':
                additionalInfo = `待维护总数：${totalCount}`;
                break;
            case 'MonthlyLotRejections':
                additionalInfo = `月批退总数：${totalCount}`;
                break;
            case 'InspectionDelay':
                additionalInfo = `检验延时总数：${totalCount}`;
                break;
            default:
                additionalInfo = `记录总数：${totalCount}`;
        }

        html = `
        <div style="margin-bottom: 20px;">
            <p style="color: #666; margin-bottom: 5px;">${additionalInfo}</p>
        </div>
    `;

        // 添加数据表格
        if (detailData.length > 0) {
            // 定义表格样式和内联CSS
            const style = `
            <style>
                .table-container {
                    height: 500px;
                    overflow-y: auto;
                    overflow-x: auto;
                    border: 1px solid #ddd;
                    border-radius: 4px;
                    position: relative;
                }

                .sticky-table {
                    width: 100%;
                    border-collapse: collapse;
                    min-width: 1200px;
                }

                .sticky-table thead {
                    position: sticky;
                    top: 0;
                    z-index: 10;
                }

                .sticky-table thead tr {
                    background: #f5f5f5 !important;
                }

                .sticky-table th {
                    position: sticky;
                    top: 0;
                    background: #f5f5f5;
                    box-shadow: 0 1px 0 #ddd;
                    z-index: 10;
                }

                .sticky-table th,
                .sticky-table td {
                    padding: 12px;
                    text-align: left;
                    border: 1px solid #ddd;
                    white-space: nowrap;
                    vertical-align: middle;
                }

                .sticky-table tbody tr:nth-child(even) {
                    background: #f9f9f9;
                }

                .sticky-table tbody tr:nth-child(odd) {
                    background: #fff;
                }

                .sticky-table tbody tr:hover {
                    background: #f0f7ff;
                }

                /* 固定第一列的样式（可选） */
                /*
                .sticky-table th:first-child,
                .sticky-table td:first-child {
                    position: sticky;
                    left: 0;
                    background: inherit;
                    z-index: 5;
                }
                */
            </style>
        `;

            html += style;
            html += `
            <div class="table-container">
                <table class="sticky-table">
                    <thead>
                        <tr>
                            <th>检验单号</th>
                            <th>所属项目</th>
                            <th>供应商</th>
                            <th>到货单号</th>
                            <th>检验状态</th>
                            <th>是否回写</th>
                            <th>品号</th>
                            <th>材料名称</th>
                            <th>批号</th>
                            <th>到货数量</th>
                            <th>进料日期</th>
                            <th>创建时间</th>
                            <th>检验项备注合并值</th>
                        </tr>
                    </thead>
                    <tbody>
        `;

            detailData.forEach((item, index) => {
                // 根据状态设置颜色
                let statusColor = '#333';
                if (item.PSTATE === '已完成') statusColor = '#1abc9c';
                if (item.PSTATE === '检验中') statusColor = '#f39c12';

                // 是否回写状态
                let isAvailableText = item.ISSY === '1' ? '是' : (item.ISSY === '' || item.ISSY === null ? '否' : item.ISSY);
                let isAvailableColor = item.ISSY === '1' ? '#1abc9c' : '#999';

                html += `
                <tr>
                    <td>${item.INSPECT_IQCCODE || ''}</td>
                    <td>${item.PROJECTNAME || ''}</td>
                    <td>${item.SUPPNAME || ''}</td>
                    <td>${item.ERP_ARRIVEDID || ''}</td>
                    <td><span style="color: ${statusColor}; font-weight: 500;">${item.PSTATE || ''}</span></td>
                    <td><span style="color: ${isAvailableColor};">${isAvailableText}</span></td>
                    <td>${item.ITEMID || ''}</td>
                    <td>${item.ITEMNAME || ''}</td>
                    <td>${item.LOTNO || ''}</td>
                    <td>${item.LOT_QTY || ''}</td>
                    <td>${item.APPLY_DATE || ''}</td>
                    <td>${item.INSPECT_IQCCREATEDATE || ''}</td>
                    <td>${item.ALL_REMARK3 || ''}</td>
                </tr>
            `;
            });

            html += `
                    </tbody>
                </table>
            </div>
        `;
        } else {
            html += `
            <div style="padding: 40px; background: #f5f7fa; border-radius: 6px; text-align: center;">
                <i class="fas fa-database" style="font-size: 48px; color: #ccc; margin-bottom: 15px;"></i>
                <p style="color: #999; font-size: 16px;">暂无数据</p>
            </div>
        `;
        }

        contentElement.innerHTML = html;
    }

    // 更新项目选择器
    function updateProjectSelectors() {
        const projects = projectOptions[viewState.materialType];

        // 更新所有项目选择器
        ['comingQualified-project', 'yearComingProject', 'comingProject', 'supplier-rank-project'].forEach(selectorId => {
            const dropdown = document.getElementById(`${selectorId}-dropdown`);
            if (dropdown) {
                dropdown.innerHTML = '';

                projects.forEach(project => {
                    const option = document.createElement('div');
                    option.className = 'selector-option';
                    option.innerHTML = `
                        <input type="checkbox" id="${selectorId}-${project}" value="${project}" checked>
                        <label for="${selectorId}-${project}">${project}</label>
                    `;
                    dropdown.appendChild(option);
                });

                // 添加确定按钮
                const applyBtn = document.createElement('button');
                applyBtn.className = 'btn';
                applyBtn.textContent = '确定';
                applyBtn.style.width = '100%';
                applyBtn.style.marginTop = '10px';
                applyBtn.onclick = function () {
                    updateChartBySelector(selectorId);
                    dropdown.style.display = 'none';
                };
                dropdown.appendChild(applyBtn);

                // 更新选中状态
                if (selectorId.includes('comingQualified')) {
                    viewState.comingQualified.projects = [...projects];
                } else if (selectorId.includes('yearComingProject')) {
                    viewState.yearComingProject.projects = [...projects];
                } else if (selectorId.includes('comingProject')) {
                    viewState.comingProject.projects = [...projects];
                } else if (selectorId.includes('supplier-rank')) {
                    viewState.supplierRank.projects = [...projects];
                }
            }
        });
    }

    // 根据选择器更新图表
    function updateChartBySelector(selectorId) {
        const projects = [];
        const checkboxes = document.querySelectorAll(`#${selectorId}-dropdown input[type="checkbox"]:checked`);
        checkboxes.forEach(cb => projects.push(cb.value));

        if (selectorId.includes('yearComingQualified')) {
            viewState.comingQualified.projects = projects;
            loadYearComingQualifiedChart();
        } else if (selectorId.includes('comingQualified')) {
            viewState.comingQualified.projects = projects;
            loadComingQualifiedChart();
        } else if (selectorId.includes('yearComingProject')) {
            viewState.yearComingProject.projects = projects;
            loadYearComingProjectChart();
        } else if (selectorId.includes('comingProject')) {
            viewState.comingProject.projects = projects;
            loadComingProjectChart();
        } else if (selectorId.includes('supplier-rank')) {
            viewState.supplierRank.projects = projects;
            renderSupplierRankData();
        }
    }

    // 更新年累计进料/累计合格率图表
    async function loadYearComingQualifiedChart() {
        // 准备请求参数
        const params = {
            MaterialType: viewState.materialType === 'massProduction' ? 1 : 2,
            SumType: 'year',
            StartDate: '',
            EndDate: '',
            MeterialNames: '',
            SuppID: ''
        };

        // 调用后端接口
        const data = await fetchData('/api/erp/GetComingQualifiedData', params);

        if (data && Array.isArray(data) && data.length > 0) {
            // 处理数据为柱状+折线图表格式
            const xAxisData = [];
            const okData = [];
            const vipData = [];
            const ngData = [];
            const rateData = [];

            // 处理返回的数据
            data.forEach(item => {
                if (item.XValue) {
                    xAxisData.push(item.XValue);
                } else {
                    xAxisData.push(item.month || '');
                }

                if (item.Statistics) {
                    okData.push(item.Statistics.OK || 0);
                    vipData.push(item.Statistics.VIP || 0);
                    ngData.push(item.Statistics.NG || 0);
                } else {
                    okData.push(item.OK || 0);
                    vipData.push(item.VIP || 0);
                    ngData.push(item.NG || 0);
                }

                rateData.push(item.Rate || 0);
            });

            // 配置图表选项（柱状+折线）
            const option = {
                title: {
                    text: '年累计进料/累计合格率',
                    left: 'center'
                },
                grid: {
                    left: 50,
                    right: 50,
                    top: 60,
                    bottom: 60
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'cross',
                        crossStyle: {
                            color: '#999'
                        }
                    },
                    formatter: function (params) {
                        let result = params[0].name + '<br/>';
                        for (let i = 0; i < params.length; i++) {
                            const param = params[i];
                            if (param.seriesType === 'line') {
                                result += `${param.marker} ${param.seriesName}: ${param.value}%<br/>`;
                            } else {
                                result += `${param.marker} ${param.seriesName}: ${param.value}<br/>`;
                            }
                        }
                        return result;
                    }
                },
                legend: {
                    data: ['合格', '特采', '批退', '累计合格率'],
                    top: 30
                },
                xAxis: [{
                    type: 'category',
                    name: '月份',
                    data: xAxisData,
                    axisPointer: {
                        type: 'shadow'
                    },
                    axisLabel: {
                        interval: 0,
                        rotate: 45
                    }
                }],
                yAxis: [{
                    type: 'value',
                    name: '累计进料',
                    alignTicks: true,
                }, {
                    type: 'value',
                    name: '累计合格率',
                    min: 0,
                    max: 100,
                    axisLabel: {
                        formatter: '{value}%'
                    }
                }],
                series: [
                    {
                        name: '合格',
                        type: 'bar',
                        stack: 'total',
                        barWidth: '60%',
                        label: {
                            show: true,
                            position: 'inside'
                        },
                        data: okData,
                        itemStyle: {
                            color: '#1abc9c'
                        }
                    },
                    {
                        name: '特采',
                        type: 'bar',
                        stack: 'total',
                        barWidth: '60%',
                        label: {
                            show: true,
                            position: 'inside'
                        },
                        data: vipData,
                        itemStyle: {
                            color: '#f1c40f'
                        }
                    },
                    {
                        name: '批退',
                        type: 'bar',
                        stack: 'total',
                        barWidth: '60%',
                        label: {
                            show: true,
                            position: 'inside'
                        },
                        data: ngData,
                        itemStyle: {
                            color: '#e74c3c'
                        }
                    },
                    {
                        name: '累计合格率',
                        type: 'line',
                        yAxisIndex: 1,
                        smooth: true,
                        smoothness: 0.5, // 可选：平滑度，0-1，默认0.5
                        tooltip: {
                            valueFormatter: function (value) {
                                return value + '%';
                            }
                        },
                        data: rateData,
                        itemStyle: {
                            color: '#3498db'
                        },
                        lineStyle: {
                            width: 3
                        },
                        symbol: 'circle',
                        symbolSize: 8
                    }
                ]
            };

            // 设置图表选项
            charts.yearComingQualified.setOption(option, true);
        } else {
            // 显示错误信息，不显示模拟数据
            const errorOption = {
                graphic: {
                    type: 'text',
                    left: 'center',
                    top: 'middle',
                    style: {
                        text: '暂无数据',
                        fontSize: 16,
                        fill: '#999'
                    }
                },
                xAxis: { show: false },
                yAxis: { show: false },
                series: []
            };

            charts.yearComingQualified.setOption(errorOption, true);
        }
    }

    // 更新累计进料/累计合格率图表
    async function loadComingQualifiedChart() {
        // 准备请求参数
        let sumType = viewState.comingQualified.type;
        let startDate = viewState.comingQualified.startDate;
        let endDate = viewState.comingQualified.endDate;

        // 如果不是自定义类型，设置默认日期范围
        if (sumType !== 'custom') {
            const end = new Date();
            const start = new Date();

            switch (sumType) {
                case 'day':
                    start.setDate(start.getDate() - 1);
                    break;
                case 'week':
                    start.setDate(start.getDate() - 7);
                    break;
                case 'month':
                    start.setDate(start.getDate() - 30);
                    break;
            }

            startDate = start.toISOString().split('T')[0];
            endDate = end.toISOString().split('T')[0];
        }

        const params = {
            MaterialType: viewState.materialType === 'massProduction' ? 1 : 2,
            SumType: sumType,
            StartDate: startDate,
            EndDate: endDate,
            MeterialNames: viewState.comingQualified.projects.join(','),
            SuppID: ''
        };

        // 调用后端接口
        const data = await fetchData('/api/erp/GetComingQualifiedData', params);

        if (data && Array.isArray(data) && data.length > 0) {
            // 处理数据为柱状+折线图表格式
            const xAxisData = [];
            const okData = [];
            const vipData = [];
            const ngData = [];
            const rateData = [];

            // 处理返回的数据
            data.forEach(item => {
                if (item.XValue) {
                    xAxisData.push(item.XValue);
                } else {
                    xAxisData.push(item.date || '');
                }

                if (item.Statistics) {
                    okData.push(item.Statistics.OK || 0);
                    vipData.push(item.Statistics.VIP || 0);
                    ngData.push(item.Statistics.NG || 0);
                } else {
                    okData.push(item.OK || 0);
                    vipData.push(item.VIP || 0);
                    ngData.push(item.NG || 0);
                }

                rateData.push(item.Rate || 0);
            });

            // 配置图表选项（柱状+折线）
            const option = {
                title: {
                    text: '累计进料/累计合格率',
                    left: 'center'
                },
                grid: {
                    left: 50,
                    right: 50,
                    top: 60,
                    bottom: 60
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'cross',
                        crossStyle: {
                            color: '#999'
                        }
                    },
                    formatter: function (params) {
                        let result = params[0].name + '<br/>';
                        for (let i = 0; i < params.length; i++) {
                            const param = params[i];
                            if (param.seriesType === 'line') {
                                result += `${param.marker} ${param.seriesName}: ${param.value}%<br/>`;
                            } else {
                                result += `${param.marker} ${param.seriesName}: ${param.value}<br/>`;
                            }
                        }
                        return result;
                    }
                },
                legend: {
                    data: ['合格', '特采', '批退', '累计合格率'],
                    top: 30
                },
                xAxis: [{
                    type: 'category',
                    name: '时间',
                    data: xAxisData,
                    axisPointer: {
                        type: 'shadow'
                    },
                    axisLabel: {
                        interval: 0,
                        rotate: 45
                    }
                }],
                yAxis: [{
                    type: 'value',
                    name: '累计进料',
                    alignTicks: true,
                }, {
                    type: 'value',
                    name: '累计合格率',
                    min: 0,
                    max: 100,
                    axisLabel: {
                        formatter: '{value}%'
                    }
                }],
                series: [
                    {
                        name: '合格',
                        type: 'bar',
                        stack: 'total',
                        barWidth: '60%',
                        label: {
                            show: true,
                            position: 'inside'
                        },
                        data: okData,
                        itemStyle: {
                            color: '#1abc9c'
                        }
                    },
                    {
                        name: '特采',
                        type: 'bar',
                        stack: 'total',
                        barWidth: '60%',
                        label: {
                            show: true,
                            position: 'inside'
                        },
                        data: vipData,
                        itemStyle: {
                            color: '#f1c40f'
                        }
                    },
                    {
                        name: '批退',
                        type: 'bar',
                        stack: 'total',
                        barWidth: '60%',
                        label: {
                            show: true,
                            position: 'inside'
                        },
                        data: ngData,
                        itemStyle: {
                            color: '#e74c3c'
                        }
                    },
                    {
                        name: '累计合格率',
                        type: 'line',
                        yAxisIndex: 1,
                        smooth: true,
                        smoothness: 0.5, // 可选：平滑度，0-1，默认0.5
                        tooltip: {
                            valueFormatter: function (value) {
                                return value + '%';
                            }
                        },
                        data: rateData,
                        itemStyle: {
                            color: '#3498db'
                        },
                        lineStyle: {
                            width: 3
                        },
                        symbol: 'circle',
                        symbolSize: 8
                    }
                ]
            };

            // 设置图表选项
            charts.comingQualified.setOption(option, true);
        } else {
            // 显示错误信息，不显示模拟数据
            const errorOption = {
                graphic: {
                    type: 'text',
                    left: 'center',
                    top: 'middle',
                    style: {
                        text: '暂无数据',
                        fontSize: 16,
                        fill: '#999'
                    }
                },
                xAxis: { show: false },
                yAxis: { show: false },
                series: []
            };

            charts.comingQualified.setOption(errorOption, true);
        }
    }

    // 更新年累计进料（按项目）图表
    async function loadYearComingProjectChart() {
        // 准备请求参数
        const params = {
            MaterialType: viewState.materialType === 'massProduction' ? 1 : 2,
            SumType: 'year',
            StartDate: '',
            EndDate: '',
            MeterialNames: viewState.yearComingProject.projects.join(','),
            SuppID: ''
        };

        // 调用后端接口
        const data = await fetchData('/api/erp/GetYearComingProjectData', params);

        if (data && Array.isArray(data)) {
            // 处理数据为柱状图表格式
            const xAxisData = [];
            const projectData = {};

            // 处理返回的数据
            data.forEach(item => {
                if (item.XValue && !xAxisData.includes(item.XValue)) {
                    xAxisData.push(item.XValue);
                }

                // 处理Statistics中的数据
                if (item.Statistics && typeof item.Statistics === 'object') {
                    Object.keys(item.Statistics).forEach(projectName => {
                        if (!projectData[projectName]) {
                            projectData[projectName] = [];
                        }

                        // 确保项目数据数组长度与当前X轴数据索引匹配
                        while (projectData[projectName].length < xAxisData.length - 1) {
                            projectData[projectName].push(0);
                        }

                        // 添加当前月份的数据
                        const count = item.Statistics[projectName] || 0;
                        projectData[projectName].push(count);
                    });
                }
            });

            // 配置图表选项（柱状图）
            const option = {
                title: {
                    text: '年累计进料（按项目）',
                    left: 'center'
                },
                grid: {
                    left: 50,
                    right: 100,
                    top: 60,
                    bottom: 60
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'cross',
                        crossStyle: {
                            color: '#999'
                        }
                    },
                    formatter: function (params) {
                        let result = `${params[0].axisValue}<br/>`;
                        params.forEach(item => {
                            result += `${item.marker} ${item.seriesName}: ${item.value}<br/>`;
                        });
                        return result;
                    }
                },
                legend: {
                    type: 'scroll',
                    orient: 'vertical',
                    right: 10,
                    top: 20,
                    bottom: 20,
                },
                xAxis: {
                    type: 'category',
                    name: '月份',
                    data: xAxisData,
                    axisPointer: {
                        type: 'shadow'
                    },
                    axisLabel: {
                        interval: 0,
                        rotate: 45
                    }
                },
                yAxis: {
                    type: 'value',
                    name: '累计进料',
                    min: 0
                },
                series: Object.keys(projectData).map(project => ({
                    name: project,
                    type: 'bar',
                    data: projectData[project],
                    label: {
                        show: true,
                        position: 'top',
                        formatter: '{c}'
                    }
                }))
            };

            // 设置图表选项
            charts.yearComingProject.setOption(option, true);
        } else {
            // 显示错误信息，不显示模拟数据
            const errorOption = {
                graphic: {
                    type: 'text',
                    left: 'center',
                    top: 'middle',
                    style: {
                        text: '暂无数据',
                        fontSize: 16,
                        fill: '#999'
                    }
                },
                xAxis: { show: false },
                yAxis: { show: false },
                series: []
            };

            charts.yearComingProject.setOption(errorOption, true);
        }
    }

    // 更新累计进料/累计合格率（按项目）图表
    async function loadComingProjectChart() {
        // 准备请求参数
        let sumType = viewState.comingProject.type;
        let startDate = viewState.comingProject.startDate;
        let endDate = viewState.comingProject.endDate;

        // 如果不是自定义类型，设置默认日期范围
        if (sumType !== 'custom') {
            const end = new Date();
            const start = new Date();

            switch (sumType) {
                case 'day':
                    start.setDate(start.getDate() - 1);
                    break;
                case 'week':
                    start.setDate(start.getDate() - 7);
                    break;
                case 'month':
                    start.setDate(start.getDate() - 30);
                    break;
            }

            startDate = start.toISOString().split('T')[0];
            endDate = end.toISOString().split('T')[0];
        }

        const params = {
            MaterialType: viewState.materialType === 'massProduction' ? 1 : 2,
            SumType: sumType,
            StartDate: startDate,
            EndDate: endDate,
            MeterialNames: viewState.comingProject.projects.join(','),
            SuppID: ''
        };

        // 调用后端接口
        const data = await fetchData('/api/erp/GetComingProjectData', params);

        if (data && Array.isArray(data) && data.length > 0) {
            // 处理数据为柱状+折线图表格式
            const xAxisData = [];
            const okData = [];
            const vipData = [];
            const ngData = [];
            const rateData = [];

            // 处理返回的数据
            data.forEach(item => {
                if (item.XValue) {
                    xAxisData.push(item.XValue);
                } else {
                    xAxisData.push(item.date || '');
                }

                if (item.Statistics) {
                    okData.push(item.Statistics.OK || 0);
                    vipData.push(item.Statistics.VIP || 0);
                    ngData.push(item.Statistics.NG || 0);
                } else {
                    okData.push(item.OK || 0);
                    vipData.push(item.VIP || 0);
                    ngData.push(item.NG || 0);
                }

                rateData.push(item.Rate || 0);
            });

            // 配置图表选项（柱状+折线）
            const option = {
                title: {
                    text: '累计进料/累计合格率（按项目）',
                    left: 'center'
                },
                grid: {
                    left: 50,
                    right: 50,
                    top: 60,
                    bottom: 60
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'cross',
                        crossStyle: {
                            color: '#999'
                        }
                    },
                    formatter: function (params) {
                        let result = params[0].name + '<br/>';
                        for (let i = 0; i < params.length; i++) {
                            const param = params[i];
                            if (param.seriesType === 'line') {
                                result += `${param.marker} ${param.seriesName}: ${param.value}%<br/>`;
                            } else {
                                result += `${param.marker} ${param.seriesName}: ${param.value}<br/>`;
                            }
                        }
                        return result;
                    }
                },
                legend: {
                    data: ['合格', '特采', '批退', '累计合格率'],
                    top: 30
                },
                xAxis: [{
                    type: 'category',
                    name: '时间',
                    data: xAxisData,
                    axisPointer: {
                        type: 'shadow'
                    },
                    axisLabel: {
                        interval: 0,
                        rotate: 45
                    }
                }],
                yAxis: [{
                    type: 'value',
                    name: '累计进料',
                    alignTicks: true,
                }, {
                    type: 'value',
                    name: '累计合格率',
                    min: 0,
                    max: 100,
                    axisLabel: {
                        formatter: '{value}%'
                    }
                }],
                series: [
                    {
                        name: '合格',
                        type: 'bar',
                        stack: 'total',
                        barWidth: '60%',
                        label: {
                            show: true,
                            position: 'inside'
                        },
                        data: okData,
                        itemStyle: {
                            color: '#1abc9c'
                        }
                    },
                    {
                        name: '特采',
                        type: 'bar',
                        stack: 'total',
                        barWidth: '60%',
                        label: {
                            show: true,
                            position: 'inside'
                        },
                        data: vipData,
                        itemStyle: {
                            color: '#f1c40f'
                        }
                    },
                    {
                        name: '批退',
                        type: 'bar',
                        stack: 'total',
                        barWidth: '60%',
                        label: {
                            show: true,
                            position: 'inside'
                        },
                        data: ngData,
                        itemStyle: {
                            color: '#e74c3c'
                        }
                    },
                    {
                        name: '累计合格率',
                        type: 'line',
                        yAxisIndex: 1,
                        smooth: true,
                        smoothness: 0.5, // 可选：平滑度，0-1，默认0.5
                        tooltip: {
                            valueFormatter: function (value) {
                                return value + '%';
                            }
                        },
                        data: rateData,
                        itemStyle: {
                            color: '#3498db'
                        },
                        lineStyle: {
                            width: 3
                        },
                        symbol: 'circle',
                        symbolSize: 8
                    }
                ]
            };

            // 设置图表选项
            charts.comingProject.setOption(option, true);
        } else {
            // 显示错误信息，不显示模拟数据
            const errorOption = {
                graphic: {
                    type: 'text',
                    left: 'center',
                    top: 'middle',
                    style: {
                        text: '暂无数据',
                        fontSize: 16,
                        fill: '#999'
                    }
                },
                xAxis: { show: false },
                yAxis: { show: false },
                series: []
            };

            charts.comingProject.setOption(errorOption, true);
        }
    }

    // 获取供应商排行数据
    async function loadSupplierRankData() {
        try {
            // 准备请求参数
            const params = {
                MaterialType: viewState.materialType === 'massProduction' ? 1 : 2,
                SumType: viewState.supplierRank.type,
                StartDate: viewState.supplierRank.startDate || '',
                EndDate: viewState.supplierRank.endDate || '',
                MeterialNames: viewState.supplierRank.projects.join(','),
                SuppID: ''
            };

            // 调用后端接口获取供应商排行数据
            const data = await fetchData('/api/erp/GetSuppBatchRejectionData', params);

            if (data &&
                (Array.isArray(data.RejectionRate) ||
                    Array.isArray(data.DefectRate) ||
                    Array.isArray(data.FeedLotQty) ||
                    Array.isArray(data.ReturnLotQty))) {
                // 处理返回的数据
                const supplierRankData = processSupplierRankData(data);
                // 渲染供应商排行数据
                renderSupplierRankData(supplierRankData);
                return supplierRankData;
            } else {
                // 显示供应商排行暂无数据
                renderNoSupplierData();
                return null;
            }
        } catch (error) {
            console.error('加载供应商排行数据失败:', error);
            renderNoSupplierData();
            return null;
        }
    }

    // 处理供应商排行数据
    function processSupplierRankData(data) {
        const supplierData = {
            nameList: [],     // 供应商名称（来自 RejectionRate）
            defectRateList: [], // 不良率（来自 DefectRate）
            incomingBatchesList: [], // 进料批数（来自 FeedLotQty）
            rejectBatchesList: []    // 批退批数（来自 ReturnLotQty）
        };

        // 供应商名称 - 对应 RejectionRate
        if (data.RejectionRate && Array.isArray(data.RejectionRate)) {
            data.RejectionRate.forEach((row, index) => {
                const suppId = row.SUPPID || '';
                const suppName = row.SUPPNAME || '';
                const value = row.VALUE || 0;

                supplierData.nameList.push({
                    rank: index + 1,
                    id: suppId,
                    name: suppName,
                    value: value
                });
            });
        }

        // 不良率 - 对应 DefectRate
        if (data.DefectRate && Array.isArray(data.DefectRate)) {
            data.DefectRate.forEach((row, index) => {
                const suppId = row.SUPPID || '';
                const suppName = row.SUPPNAME || '';
                const value = row.VALUE || 0;

                supplierData.defectRateList.push({
                    rank: index + 1,
                    id: suppId,
                    name: suppName,
                    value: value
                });
            });
        }

        // 进料批数 - 对应 FeedLotQty
        if (data.FeedLotQty && Array.isArray(data.FeedLotQty)) {
            data.FeedLotQty.forEach((row, index) => {
                const suppId = row.SUPPID || '';
                const suppName = row.SUPPNAME || '';
                const value = row.VALUE || 0;

                supplierData.incomingBatchesList.push({
                    rank: index + 1,
                    id: suppId,
                    name: suppName,
                    value: value
                });
            });
        }

        // 批退批数 - 对应 ReturnLotQty
        if (data.ReturnLotQty && Array.isArray(data.ReturnLotQty)) {
            data.ReturnLotQty.forEach((row, index) => {
                const suppId = row.SUPPID || '';
                const suppName = row.SUPPNAME || '';
                const value = row.VALUE || 0;

                supplierData.rejectBatchesList.push({
                    rank: index + 1,
                    id: suppId,
                    name: suppName,
                    value: value
                });
            });
        }

        // 只取前5名
        return {
            nameList: supplierData.nameList.slice(0, 5),
            defectRateList: supplierData.defectRateList.slice(0, 5),
            incomingBatchesList: supplierData.incomingBatchesList.slice(0, 5),
            rejectBatchesList: supplierData.rejectBatchesList.slice(0, 5)
        };
    }

    // 更新供应商数据来源说明
    function updateDataSourceNote() {
        const noteElement = document.getElementById('supplier-data-note');
        let noteText = '';

        switch (viewState.supplierRank.type) {
            case 'day':
                noteText = '显示最近7日数据';
                break;
            case 'week':
                noteText = '显示最近7周数据';
                break;
            case 'month':
                noteText = '显示最近7月数据';
                break;
            case 'custom':
                if (viewState.supplierRank.startDate && viewState.supplierRank.endDate) {
                    noteText = `显示${viewState.supplierRank.startDate}至${viewState.supplierRank.endDate}数据`;
                } else {
                    noteText = '显示自定义时间范围数据';
                }
                break;
            default:
                noteText = '显示最近7日数据';
        }

        noteElement.innerHTML = `<i class="fas fa-info-circle"></i><span>${noteText}</span>`;
    }

    // 渲染供应商排行暂无数据
    function renderNoSupplierData() {
        // 供应商名称列表
        const nameList = document.getElementById('supplier-name-list');
        nameList.innerHTML = `
        <li class="supplier-item" style="justify-content: center; color: #999;">
            暂无数据
        </li>
    `;

        // 不良率列表
        const defectRateList = document.getElementById('defect-rate-list');
        defectRateList.innerHTML = `
        <li class="supplier-item" style="justify-content: center; color: #999;">
            暂无数据
        </li>
    `;

        // 进料批数列表
        const incomingBatchesList = document.getElementById('incoming-batches-list');
        incomingBatchesList.innerHTML = `
        <li class="supplier-item" style="justify-content: center; color: #999;">
            暂无数据
        </li>
    `;

        // 批退批数列表
        const rejectBatchesList = document.getElementById('reject-batches-list');
        rejectBatchesList.innerHTML = `
        <li class="supplier-item" style="justify-content: center; color: #999;">
            暂无数据
        </li>
    `;
    }

    // 渲染供应商排行数据
    function renderSupplierRankData(supplierData) {
        if (!supplierData ||
            (!supplierData.nameList || supplierData.nameList.length === 0) &&
            (!supplierData.defectRateList || supplierData.defectRateList.length === 0) &&
            (!supplierData.incomingBatchesList || supplierData.incomingBatchesList.length === 0) &&
            (!supplierData.rejectBatchesList || supplierData.rejectBatchesList.length === 0)) {
            renderNoSupplierData();
            return;
        }
        // 渲染供应商名称列表
        const nameList = document.getElementById('supplier-name-list');
        nameList.innerHTML = '';

        if (supplierData.nameList && supplierData.nameList.length > 0) {
            supplierData.nameList.forEach((supplier, index) => {
                const li = document.createElement('li');
                li.className = 'supplier-item';
                li.innerHTML = `
                <span class="supplier-rank-number">${supplier.rank}</span>
                <span class="supplier-name" data-supplier-id="${supplier.id}">${supplier.name}</span>
                <span class="supplier-value">${supplier.value}%</span>
            `;
                nameList.appendChild(li);
            });
        } else {
            nameList.innerHTML = `
            <li class="supplier-item" style="justify-content: center; color: #999;">
                暂无数据
            </li>
        `;
        }

        // 渲染不良率列表
        const defectRateList = document.getElementById('defect-rate-list');
        defectRateList.innerHTML = '';

        if (supplierData.defectRateList && supplierData.defectRateList.length > 0) {
            supplierData.defectRateList.forEach((supplier, index) => {
                const li = document.createElement('li');
                li.className = 'supplier-item';
                li.innerHTML = `
                <span class="supplier-rank-number">${supplier.rank}</span>
                <span class="supplier-name" data-supplier-id="${supplier.id}">${supplier.name}</span>
                <span class="supplier-value defect-rate">${supplier.value}%</span>
            `;
                defectRateList.appendChild(li);
            });
        } else {
            defectRateList.innerHTML = `
            <li class="supplier-item" style="justify-content: center; color: #999;">
                暂无数据
            </li>
        `;
        }

        // 渲染进料批数列表
        const incomingBatchesList = document.getElementById('incoming-batches-list');
        incomingBatchesList.innerHTML = '';

        if (supplierData.incomingBatchesList && supplierData.incomingBatchesList.length > 0) {
            supplierData.incomingBatchesList.forEach((supplier, index) => {
                const li = document.createElement('li');
                li.className = 'supplier-item';
                li.innerHTML = `
                <span class="supplier-rank-number">${supplier.rank}</span>
                <span class="supplier-name" data-supplier-id="${supplier.id}">${supplier.name}</span>
                <span class="supplier-value incoming-batches">${supplier.value.toLocaleString()}</span>
            `;
                incomingBatchesList.appendChild(li);
            });
        } else {
            incomingBatchesList.innerHTML = `
            <li class="supplier-item" style="justify-content: center; color: #999;">
                暂无数据
            </li>
        `;
        }

        // 渲染批退批数列表
        const rejectBatchesList = document.getElementById('reject-batches-list');
        rejectBatchesList.innerHTML = '';

        if (supplierData.rejectBatchesList && supplierData.rejectBatchesList.length > 0) {
            supplierData.rejectBatchesList.forEach((supplier, index) => {
                const li = document.createElement('li');
                li.className = 'supplier-item';
                li.innerHTML = `
                <span class="supplier-rank-number">${supplier.rank}</span>
                <span class="supplier-name" data-supplier-id="${supplier.id}">${supplier.name}</span>
                <span class="supplier-value reject-batches">${supplier.value.toLocaleString()}</span>
            `;
                rejectBatchesList.appendChild(li);
            });
        } else {
            rejectBatchesList.innerHTML = `
            <li class="supplier-item" style="justify-content: center; color: #999;">
                暂无数据
            </li>
        `;
        }

        // 更新数据来源说明
        updateDataSourceNote();

        // 保存当前供应商数据到全局状态
        viewState.currentSupplierData = supplierData;
    }

    // 显示供应商详情
    async function showSupplierDetail(supplierId) {
        try {
            // 准备请求参数
            const params = {
                MaterialType: viewState.materialType === 'massProduction' ? 1 : 2,
                SumType: viewState.supplierRank.type,
                StartDate: viewState.supplierRank.startDate || '',
                EndDate: viewState.supplierRank.endDate || '',
                MeterialNames: viewState.supplierRank.projects.join(','),
                SuppID: supplierId
            };

            const modal = document.getElementById('supplier-detail-modal');
            const content = document.getElementById('supplier-detail-content');

            // 显示加载状态
            content.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> 加载中...</div>';
            modal.classList.add('active');

            // 调用后端接口获取供应商详情
            const detailData = await fetchData('/api/erp/GetSuppBatchRejectionDetailData', params);

            // 渲染详情数据
            if (detailData && Array.isArray(detailData)) {
                renderSupplierDetailContent(detailData, content, supplierId);
            } else {
                content.innerHTML = `
                <div style="padding: 40px; text-align: center;">
                    <i class="fas fa-exclamation-triangle" style="font-size: 48px; color: #f39c12; margin-bottom: 15px;"></i>
                    <p style="color: #666; margin-bottom: 10px;">暂无数据</p>
                </div>
            `;
            }
        } catch (error) {
            console.error('加载供应商详情失败:', error);
            const modal = document.getElementById('supplier-detail-modal');
            const content = document.getElementById('supplier-detail-content');
            content.innerHTML = `
            <div style="padding: 40px; text-align: center;">
                <i class="fas fa-exclamation-triangle" style="font-size: 48px; color: #e74c3c; margin-bottom: 15px;"></i>
                <p style="color: #666; margin-bottom: 10px;">数据加载失败</p>
                <p style="color: #999; font-size: 14px;">${error.message}</p>
            </div>
        `;
        }
    }

    // 渲染供应商详情内容
    function renderSupplierDetailContent(detailData, contentElement, supplierId) {
        let html = '';

        // 检查数据格式
        if (!detailData || !Array.isArray(detailData) || detailData.length === 0) {
            html = `
            <div style="padding: 20px; background: #f5f7fa; border-radius: 6px;">
                <p style="color: #666; text-align: center;">暂无数据</p>
            </div>
        `;
            contentElement.innerHTML = html;
            return;
        }

        // 获取供应商名称（从第一条记录中获取）
        const supplierName = detailData[0]?.SUPPNAME || '未知供应商';
        const totalRecords = detailData.length;

        html = `
        <div style="margin-bottom: 20px;">
            <h3 style="margin-bottom: 10px;">${supplierName} - 质量明细</h3>
            <p style="color: #666; margin-bottom: 15px;">记录总数：${totalRecords}</p>
        </div>
    `;

        // 添加数据表格
        const style = `
        <style>
            .table-container {
                height: 500px;
                overflow-y: auto;
                overflow-x: auto;
                border: 1px solid #ddd;
                border-radius: 4px;
                position: relative;
            }

            .sticky-table {
                width: 100%;
                border-collapse: collapse;
                min-width: 1200px;
            }

            .sticky-table thead {
                position: sticky;
                top: 0;
                z-index: 10;
            }

            .sticky-table thead tr {
                background: #f5f5f5 !important;
            }

            .sticky-table th {
                position: sticky;
                top: 0;
                background: #f5f5f5;
                box-shadow: 0 1px 0 #ddd;
                z-index: 10;
            }

            .sticky-table th,
            .sticky-table td {
                padding: 12px;
                text-align: left;
                border: 1px solid #ddd;
                white-space: nowrap;
                vertical-align: middle;
            }

            .sticky-table tbody tr:nth-child(even) {
                background: #f9f9f9;
            }

            .sticky-table tbody tr:nth-child(odd) {
                background: #fff;
            }

            .sticky-table tbody tr:hover {
                background: #f0f7ff;
            }
        </style>
    `;

        html += style;
        html += `
        <div class="table-container">
            <table class="sticky-table">
                <thead>
                    <tr>
                        <th>检验单号</th>
                        <th>供应商</th>
                        <th>品号</th>
                        <th>材料名称</th>
                        <th>到货单号</th>
                        <th>批号</th>
                        <th>到货数量</th>
                        <th>进料日期</th>
                        <th>创建时间</th>
                        <th>备注</th>
                    </tr>
                </thead>
                <tbody>
    `;

        detailData.forEach((item, index) => {
            html += `
            <tr>
                <td>${item.INSPECT_IQCCODE || ''}</td>
                <td>${item.SUPPNAME || ''}</td>
                <td>${item.ITEMID || ''}</td>
                <td>${item.ITEMNAME || ''}</td>
                <td>${item.ERP_ARRIVEDID || ''}</td>
                <td>${item.LOTNO || ''}</td>
                <td>${item.LOT_QTY || ''}</td>
                <td>${item.APPLY_DATE || ''}</td>
                <td>${item.INSPECT_IQCCREATEDATE || ''}</td>
                <td>${item.ALL_REMARK3 || ''}</td>
            </tr>
        `;
        });

        html += `
                </tbody>
            </table>
        </div>
    `;

        contentElement.innerHTML = html;
    }

    // 全部供应商数据
    async function showAllSuppliers() {
        try {
            const modal = document.getElementById('all-suppliers-modal');
            const content = document.getElementById('all-suppliers-content');

            // 显示加载状态
            content.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> 加载中...</div>';
            modal.classList.add('active');

            // 准备请求参数
            const params = {
                MaterialType: viewState.materialType === 'massProduction' ? 1 : 2,
                SumType: viewState.supplierRank.type,
                StartDate: viewState.supplierRank.startDate || '',
                EndDate: viewState.supplierRank.endDate || '',
                MeterialNames: viewState.supplierRank.projects.join(','),
                SuppID: ''
            };

            // 调用后端接口获取所有供应商数据
            const data = await fetchData('/api/erp/GetSuppBatchRejectionDetailData', params);

            if (data) {
                // 处理返回的数据（可能是JSON字符串或已经解析的对象）
                let detailData = data;

                // 如果返回的是字符串，尝试解析
                if (typeof detailData === 'string') {
                    try {
                        detailData = JSON.parse(detailData);
                    } catch (e) {
                        console.warn('解析数据字符串失败:', e);
                    }
                }

                // 确保是数组格式
                if (Array.isArray(detailData)) {
                    renderAllSuppliersDetailContent(detailData, content);
                } else {
                    content.innerHTML = `
                <div style="padding: 40px; text-align: center;">
                    <i class="fas fa-exclamation-triangle" style="font-size: 48px; color: #f39c12; margin-bottom: 15px;"></i>
                    <p style="color: #666; margin-bottom: 10px;">数据格式不正确</p>
                </div>
            `;
                }
            } else {
                content.innerHTML = `
            <div style="padding: 40px; text-align: center;">
                <i class="fas fa-database" style="font-size: 48px; color: #ccc; margin-bottom: 15px;"></i>
                <p style="color: #999; font-size: 16px;">暂无数据</p>
            </div>
        `;
            }
        } catch (error) {
            console.error('加载全部供应商数据失败:', error);
            const content = document.getElementById('all-suppliers-content');
            content.innerHTML = `
            <div style="padding: 40px; text-align: center;">
                <i class="fas fa-exclamation-triangle" style="font-size: 48px; color: #e74c3c; margin-bottom: 15px;"></i>
                <p style="color: #666; margin-bottom: 10px;">数据加载失败</p>
                <p style="color: #999; font-size: 14px;">${error.message}</p>
            </div>
        `;
        }
    }

    // 渲染全部供应商明细内容
    function renderAllSuppliersDetailContent(detailData, contentElement) {
        if (!detailData || !Array.isArray(detailData) || detailData.length === 0) {
            contentElement.innerHTML = `
        <div style="padding: 40px; background: #f5f7fa; border-radius: 6px; text-align: center;">
            <i class="fas fa-database" style="font-size: 48px; color: #ccc; margin-bottom: 15px;"></i>
            <p style="color: #999; font-size: 16px;">暂无数据</p>
        </div>
    `;
            return;
        }

        // 统计信息
        const totalRecords = detailData.length;
        const suppliers = [...new Set(detailData.map(item => item.SUPPNAME || ''))].filter(name => name);
        const supplierCount = suppliers.length;

        let html = '';
        // 添加数据表格样式
        const style = `
    <style>
        .detail-table-container {
            height: 500px;
            overflow-y: auto;
            overflow-x: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
            position: relative;
        }

        .detail-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1400px;
        }

        .detail-table thead {
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .detail-table thead tr {
            background: #f5f5f5 !important;
        }

        .detail-table th {
            position: sticky;
            top: 0;
            background: #f5f5f5;
            box-shadow: 0 1px 0 #ddd;
            z-index: 10;
            font-weight: 600;
            text-align: left;
        }

        .detail-table th,
        .detail-table td {
            padding: 12px;
            border: 1px solid #ddd;
            white-space: nowrap;
            vertical-align: middle;
            font-size: 14px;
        }

        .detail-table tbody tr:nth-child(even) {
            background: #f9f9f9;
        }

        .detail-table tbody tr:nth-child(odd) {
            background: #fff;
        }

        .detail-table tbody tr:hover {
            background: #f0f7ff !important;
        }

        .supplier-cell {
            cursor: pointer;
            color: #409eff;
            text-decoration: underline;
        }

        .supplier-cell:hover {
            color: #337ecc;
        }
    </style>
`;

        html += style;

        // 开始表格
        html += `
    <div class="detail-table-container">
        <table class="detail-table">
            <thead>
                <tr>
                    <th style="min-width: 120px;">检验单号</th>
                    <th style="min-width: 150px;">供应商</th>
                    <th style="min-width: 100px;">品号</th>
                    <th style="min-width: 150px;">材料名称</th>
                    <th style="min-width: 120px;">到货单号</th>
                    <th style="min-width: 100px;">批号</th>
                    <th style="min-width: 80px;">到货数量</th>
                    <th style="min-width: 100px;">进料日期</th>
                    <th style="min-width: 100px;">创建时间</th>
                    <th style="min-width: 200px;">备注</th>
                </tr>
            </thead>
            <tbody>
`;

        // 添加表格数据行
        detailData.forEach((item, index) => {
            // 处理日期格式
            const applyDate = item.APPLY_DATE ? formatDate(item.APPLY_DATE) : '';
            const createDate = item.INSPECT_IQCCREATEDATE ? formatDate(item.INSPECT_IQCCREATEDATE) : '';

            html += `
        <tr>
            <td>${item.INSPECT_IQCCODE || ''}</td>
            <td>
                <span class="supplier-cell" data-supplier-id="${item.SUPPID || ''}"
                      onclick="showSupplierDetail('${item.SUPPID || ''}')">
                    ${item.SUPPNAME || ''}
                </span>
            </td>
            <td>${item.ITEMID || ''}</td>
            <td>${item.ITEMNAME || ''}</td>
            <td>${item.ERP_ARRIVEDID || ''}</td>
            <td>${item.LOTNO || ''}</td>
            <td>${item.LOT_QTY || ''}</td>
            <td>${applyDate}</td>
            <td>${createDate}</td>
            <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis;"
                title="${item.ALL_REMARK3 || ''}">
                ${item.ALL_REMARK3 || ''}
            </td>
        </tr>
    `;
        });

        html += `
            </tbody>
        </table>
    </div>
`;

        contentElement.innerHTML = html;
    }

    // 辅助函数：格式化日期
    function formatDate(dateString) {
        if (!dateString) return '';

        try {
            // 处理各种可能的日期格式
            const date = new Date(dateString);
            if (isNaN(date.getTime())) {
                return dateString;
            }

            return date.toLocaleDateString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
        } catch (e) {
            return dateString;
        }
    }

    // 事件处理
    function initEventListeners() {
        // 物料类型切换
        document.getElementById('mass-production-btn').addEventListener('click', function () {
            if (viewState.materialType !== 'massProduction') {
                document.getElementById('mass-production-btn').classList.add('active');
                document.getElementById('rd-btn').classList.remove('active');
                viewState.materialType = 'massProduction';

                // 显示检验延时卡片
                const inspectionDelayCard = document.getElementById('inspection-delay');
                inspectionDelayCard.classList.remove('hidden');

                updateProjectSelectors();
                // 重新加载统计数据
                loadStatsData();
                // 重新加载所有图表数据
                reloadAllData();
            }
        });

        document.getElementById('rd-btn').addEventListener('click', function () {
            if (viewState.materialType !== 'rd') {
                document.getElementById('rd-btn').classList.add('active');
                document.getElementById('mass-production-btn').classList.remove('active');
                viewState.materialType = 'rd';

                // 隐藏检验延时卡片
                const inspectionDelayCard = document.getElementById('inspection-delay');
                inspectionDelayCard.classList.add('hidden');

                updateProjectSelectors();
                // 重新加载统计数据
                loadStatsData();
                // 重新加载所有图表数据
                reloadAllData();
            }
        });

        // 统计卡片点击事件
        document.querySelectorAll('.stats-container li').forEach(li => {
            li.addEventListener('click', function () {
                const statType = this.getAttribute('data-type');
                const statName = this.textContent.split('：')[0];
                showStatDetail(statType, statName);
            });
        });

        // 项目选择器点击事件
        document.querySelectorAll('.selector-btn').forEach(btn => {
            btn.addEventListener('click', function () {
                const selectorId = this.id.replace('-btn', '');
                const dropdown = document.getElementById(`${selectorId}-dropdown`);
                if (dropdown) {
                    dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
                }
            });
        });

        // 图表类型切换
        document.querySelectorAll('.btn[data-chart][data-type]').forEach(btn => {
            btn.addEventListener('click', function () {
                const chartId = this.getAttribute('data-chart');
                const type = this.getAttribute('data-type');

                // 更新按钮状态
                const parent = this.parentNode;
                parent.querySelectorAll('.btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');

                // 更新视图状态
                viewState[chartId].type = type;

                // 显示/隐藏日期选择器
                if (type === 'custom') {
                    document.getElementById(`${chartId}-date-picker`).classList.remove('hidden');
                } else {
                    document.getElementById(`${chartId}-date-picker`).classList.add('hidden');
                    // 重新加载对应图表
                    if (chartId === 'yearComingQualified') {
                        loadYearComingQualifiedChart();
                    } else if (chartId === 'comingQualified') {
                        loadComingQualifiedChart();
                    } else if (chartId === 'yearComingProject') {
                        loadYearComingProjectChart();
                    } else if (chartId === 'comingProject') {
                        loadComingProjectChart();
                    } else if (chartId === 'supplierRank') {
                        loadSupplierRankData();
                    }
                }
            });
        });

        // 日期范围应用按钮
        document.getElementById('comingQualified-apply').addEventListener('click', function () {
            if (!viewState.comingQualified.startDate || !viewState.comingQualified.endDate) {
                alert('请选择开始日期和结束日期');
                return;
            }
            document.getElementById('comingQualified-date-picker').classList.add('hidden');
            loadComingQualifiedChart();
        });

        document.getElementById('comingProject-apply').addEventListener('click', function () {
            if (!viewState.comingProject.startDate || !viewState.comingProject.endDate) {
                alert('请选择开始日期和结束日期');
                return;
            }
            document.getElementById('comingProject-date-picker').classList.add('hidden');
            loadComingProjectChart();
        });

        document.getElementById('supplier-rank-apply').addEventListener('click', function () {
            if (!viewState.supplierRank.startDate || !viewState.supplierRank.endDate) {
                alert('请选择开始日期和结束日期');
                return;
            }
            document.getElementById('supplier-rank-date-picker').classList.add('hidden');
            loadSupplierRankData();
        });

        // 显示全部供应商按钮
        document.getElementById('show-all-suppliers-btn').addEventListener('click', showAllSuppliers);

        // 统计模态框关闭按钮
        document.getElementById('stat-modal-close').addEventListener('click', function () {
            document.getElementById('stat-detail-modal').classList.remove('active');
        });

        // 供应商名称点击事件（委托事件处理）
        document.addEventListener('click', function (e) {
            // 供应商名称点击
            if (e.target.classList.contains('supplier-name')) {
                const supplierId = e.target.getAttribute('data-supplier-id');
                showSupplierDetail(supplierId);
            }

            // 异常表格中的供应商名称点击
            if (e.target.classList.contains('supplier-name-cell')) {
                const supplierName = e.target.getAttribute('data-supplier-name');
                const supplier = supplierData.find(s => s.name === supplierName);
                if (supplier) {
                    showSupplierDetail(supplier.id);
                }
            }
        });

        // 模态框关闭按钮
        document.getElementById('supplier-modal-close').addEventListener('click', function () {
            document.getElementById('supplier-detail-modal').classList.remove('active');
        });

        document.getElementById('all-suppliers-modal-close').addEventListener('click', function () {
            document.getElementById('all-suppliers-modal').classList.remove('active');
        });

        // 点击模态框背景关闭
        document.querySelectorAll('.modal, .stat-modal').forEach(modal => {
            modal.addEventListener('click', function (e) {
                if (e.target === this) {
                    this.classList.remove('active');
                }
            });
        });

        // 全部供应商表格中的供应商名称点击也可以跳到详情
        document.addEventListener('click', function (e) {
            if (e.target.classList.contains('supplier-cell')) {
                const supplierId = e.target.getAttribute('data-supplier-id');
                if (supplierId) {
                    e.preventDefault();
                    e.stopPropagation();
                    showSupplierDetail(supplierId);
                }
            }
        });
    }

    // 重新加载所有数据
    function reloadAllData() {
        // 重新加载统计数据
        loadStatsData();
        // 重新加载图表数据
        loadChartsData();
        // 重新渲染供应商排行
        renderSupplierRankData();

        // 根据物料类型设置卡片显示状态
        const inspectionDelayCard = document.getElementById('inspection-delay');
        if (viewState.materialType === 'massProduction') {
            inspectionDelayCard.style.display = 'flex';
        } else {
            inspectionDelayCard.style.display = 'none';
        }
    }

    // 加载所有图表数据
    function loadChartsData() {
        loadYearComingQualifiedChart();
        loadComingQualifiedChart();
        loadYearComingProjectChart();
        loadComingProjectChart();
    }

    // 初始化
    document.addEventListener('DOMContentLoaded', function () {
        // 设置默认日期范围
        setDefaultDateRange();
        // 初始化日期选择器
        initDatePickers();
        // 根据选择器更新图表
        updateProjectSelectors();
        // 事件处理
        initEventListeners();

        // 加载统计数据
        loadStatsData().then(() => {
            // 加载图表数据
            loadChartsData();
            // 加载供应商排行数据
            loadSupplierRankData();
            // 更新供应商数据来源说明
            updateDataSourceNote();
        });

        // 初始加载完成后显示图表
        setTimeout(() => {
            // 确保图表在数据加载后正确渲染
            Object.values(charts).forEach(chart => chart.resize());
        }, 100);
    });

    // 窗口大小变化时调整图表
    window.addEventListener('resize', function () {
        Object.values(charts).forEach(chart => chart.resize());
    });
</script>
</html>