<!DOCTYPE html>
<html>
<head>
    <title>质量看板</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style type="text/css">
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Microsoft YaHei', sans-serif;
        }

        body {
            background: #f5f7fa;
            padding: 20px;
        }

        .title {
            display: flex;
            font-size: 24px;
            font-weight: bold;
            width: 100%;
            justify-content: center;
            margin-bottom: 20px;
            color: #333;
        }

        .container {
            width: 100%;
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            padding: 0 20px;
        }

        /* 物料类型选择器 */
        .material-type-selector {
            width: 100%;
            margin-bottom: 20px;
            padding: 0 20px;
        }

        .btn-group {
            display: flex;
            border-radius: 4px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .btn {
            padding: 8px 16px;
            background: #f0f2f5;
            border: none;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            color: #333;
        }

            .btn:hover {
                background: #e1e5eb;
            }

            .btn.active {
                background: #409eff;
                color: white;
            }

        .btn-primary {
            background: #409eff;
            color: white;
            padding: 10px 20px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

            .btn-primary:hover {
                background: #337ecc;
            }

        /* 顶部统计卡片 */
        .stats-container {
            width: 100%;
            padding: 0;
            list-style-type: none;
            display: inline-flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }

            .stats-container li {
                border: 1px solid #000;
                padding: 20px 24px;
                display: flex;
                justify-content: center;
                align-items: center;
                font-size: 18px;
                font-weight: bold;
                border-radius: 10px;
                cursor: pointer;
                transition: all 0.3s;
                min-width: 150px;
                text-align: center;
                flex: 1;
                margin: 0 5px;
            }

                .stats-container li:hover {
                    transform: translateY(-2px);
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                }

                .stats-container li:nth-child(1) {
                    background: rgba(26, 188, 156, .1);
                    color: #1abc9c;
                    border-color: #1abc9c;
                }

                .stats-container li:nth-child(2) {
                    background: rgba(52, 152, 219, .1);
                    color: #3498db;
                    border-color: #3498db;
                }

                .stats-container li:nth-child(3) {
                    background: rgba(155, 89, 182, .1);
                    color: #9b59b6;
                    border-color: #9b59b6;
                }

                .stats-container li:nth-child(4) {
                    background: rgba(241, 196, 15, .1);
                    color: #f1c40f;
                    border-color: #f1c40f;
                }

                .stats-container li:nth-child(5) {
                    background: rgba(231, 76, 60, .1);
                    color: #e74c3c;
                    border-color: #e74c3c;
                }

                .stats-container li:nth-child(6) {
                    background: rgba(52, 73, 94, .1);
                    color: #34495e;
                    border-color: #34495e;
                }

                .stats-container li.inspection-delay {
                    display: flex !important;
                }

        .line-title {
            padding-left: 12px;
            display: flex;
            align-items: center;
            width: 100%;
            font-size: 16px;
            font-weight: bold;
            margin-top: 20px;
            margin-bottom: 12px;
            border-left: 3px solid #2980b9;
        }

        /* 图表容器样式 */
        .chart-container {
            width: calc(50% - 5px);
            height: 600px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
            padding: 15px;
            display: flex;
            flex-direction: column;
            margin-bottom: 10px;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .chart-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }

        .chart-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .date-range-picker {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        .date-input {
            padding: 6px 10px;
            border: 1px solid #dcdfe6;
            border-radius: 4px;
            font-size: 14px;
            width: 130px;
        }

        .project-selector, .material-selector {
            position: relative;
        }

        .selector-btn {
            padding: 6px 12px;
            background: #f0f2f5;
            border: 1px solid #dcdfe6;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .selector-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            background: white;
            border: 1px solid #dcdfe6;
            border-radius: 4px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
            padding: 10px;
            z-index: 100;
            width: 200px;
            display: none;
        }

        .selector-option {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }

            .selector-option input {
                margin-right: 8px;
            }

        .chart-content {
            flex: 1;
            width: 100%;
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            font-size: 16px;
            color: #666;
        }

        .hidden {
            display: none !important;
        }

        /* 供应商质量排行样式 - 根据图片设计 */
        .supplier-rank-container {
            width: 100%;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
        }

        .supplier-rank-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .supplier-rank-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

            .supplier-rank-title i {
                color: #409eff;
            }

        .supplier-rank-content {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .supplier-rank-block {
            border: 1px solid #e4e7ed;
            border-radius: 6px;
            padding: 15px;
            background: white;
        }

        .supplier-rank-block-title {
            font-size: 14px;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 1px solid #f0f0f0;
        }

        .supplier-list {
            list-style: none;
        }

        .supplier-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px dashed #f0f0f0;
            cursor: pointer;
            transition: all 0.3s;
        }

            .supplier-item:hover {
                background: #f5f7fa;
            }

            .supplier-item:last-child {
                border-bottom: none;
            }

        .supplier-rank-number {
            font-size: 14px;
            color: #666;
            margin-right: 8px;
            min-width: 20px;
        }

        .supplier-name {
            font-size: 14px;
            color: #333;
            flex: 1;
            cursor: pointer;
        }

            .supplier-name:hover {
                color: #409eff;
                text-decoration: underline;
            }

        .supplier-value {
            font-size: 14px;
            color: #333;
        }

            .supplier-value.defect-rate {
                color: #e74c3c;
                font-weight: 600;
            }

            .supplier-value.incoming-batches {
                color: #3498db;
                font-weight: 600;
            }

            .supplier-value.reject-batches {
                color: #f39c12;
                font-weight: 600;
            }

        .data-source-note {
            font-size: 12px;
            color: #999;
            margin-top: 10px;
            padding: 8px;
            background: #f9f9f9;
            border-radius: 4px;
            border-left: 3px solid #409eff;
        }

            .data-source-note i {
                margin-right: 5px;
            }

        .show-all-btn {
            text-align: center;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px dashed #e4e7ed;
        }

        .material-name {
            color: #333;
        }

        .supplier-name-cell {
            color: #606266;
            cursor: pointer;
        }

            .supplier-name-cell:hover {
                color: #409eff;
                text-decoration: underline;
            }

        .defect-type {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }

            .defect-type.appearance {
                background: #fff3cd;
                color: #856404;
                border: 1px solid #ffeaa7;
            }

            .defect-type.dimension {
                background: #d1ecf1;
                color: #0c5460;
                border: 1px solid #bee5eb;
            }

            .defect-type.performance {
                background: #f8d7da;
                color: #721c24;
                border: 1px solid #f5c6cb;
            }

            .defect-type.material {
                background: #d4edda;
                color: #155724;
                border: 1px solid #c3e6cb;
            }

        .discovery-date {
            color: #606266;
        }

        .priority {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }

            .priority.high {
                background: #f8d7da;
                color: #721c24;
                border: 1px solid #f5c6cb;
            }

            .priority.medium {
                background: #fff3cd;
                color: #856404;
                border: 1px solid #ffeaa7;
            }

            .priority.low {
                background: #d1ecf1;
                color: #0c5460;
                border: 1px solid #bee5eb;
            }

        .action-btn {
            padding: 6px 12px;
            background: #409eff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }

            .action-btn:hover {
                background: #337ecc;
            }

        /* 模态框样式 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

            .modal.active {
                display: flex;
            }

        .modal-content {
            background: white;
            border-radius: 8px;
            width: 90%;
            max-width: 1000px;
            max-height: 80vh;
            overflow: auto;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #999;
        }

            .modal-close:hover {
                color: #333;
            }

        .modal-body {
            padding: 20px;
        }

        /* 响应式调整 */
        @media (max-width: 1200px) {
            .supplier-rank-content {
                grid-template-columns: repeat(2, 1fr);
            }

            .chart-container {
                width: 100%;
            }
        }

        @media (max-width: 768px) {
            .supplier-rank-content {
                grid-template-columns: 1fr;
            }

            .stats-container {
                flex-wrap: wrap;
            }

                .stats-container li {
                    min-width: calc(50% - 10px);
                    margin-bottom: 10px;
                }
        }
    </style>
</head>
<body>
    <div class="title">
        质量看板
    </div>

    <!-- 物料类型选择器 -->
    <div class="material-type-selector">
        <div class="btn-group">
            <button class="btn active" id="mass-production-btn">量产类物料</button>
            <button class="btn" id="rd-btn">研发类物料</button>
        </div>
    </div>

    <div class="container">
        <ul class="stats-container">
            <li id="verified-qty" data-api="/api/erp/GetVerifiedQtyData">已检验数量：0</li>
            <li id="pending-inspection" data-api="/api/erp/GetPendingInspectionQtyData">物料待检验数量：0</li>
            <li id="awaiting-disposition" data-api="/api/erp/GetQtyAwaitingDispositionData">待判定数量：0</li>
            <li id="pending-maintenance" data-api="/api/erp/GetPendingMaterialMaintenanceData">物料待维护数量：0</li>
            <li id="monthly-rejections" data-api="/api/erp/GetMonthlyLotRejectionsData">当月批退数：0</li>
            <li id="inspection-delay" class="inspection-delay" data-api="/api/erp/GetInspectionDelayData">检验延时：0</li>
        </ul>

        <!-- 年累计进料/累计合格率 -->
        <div class="chart-container">
            <div class="chart-header">
                <div class="chart-title">年累计进料/累计合格率</div>
                <div class="chart-controls">
                    <div class="btn-group">
                        <button class="btn active" data-chart="yearComingQualified" data-type="year">年</button>
                    </div>
                </div>
            </div>
            <div id="yearComingQualified" class="chart-content">
                <div class="loading">加载中...</div>
            </div>
        </div>

        <!-- 累计进料/累计合格率 -->
        <div class="chart-container">
            <div class="chart-header">
                <div class="chart-title">累计进料/累计合格率</div>
                <div class="chart-controls">
                    <div class="project-selector">
                        <button class="selector-btn" id="comingQualified-project-btn">
                            选择项目 ▼
                        </button>
                        <div class="selector-dropdown" id="comingQualified-project-dropdown">
                            <!-- 项目选项将通过JS动态生成 -->
                        </div>
                    </div>
                    <div class="btn-group">
                        <button class="btn active" data-chart="comingQualified" data-type="day">日</button>
                        <button class="btn" data-chart="comingQualified" data-type="week">周</button>
                        <button class="btn" data-chart="comingQualified" data-type="month">月</button>
                        <button class="btn" data-chart="comingQualified" data-type="custom">自定义</button>
                    </div>
                </div>
            </div>
            <div class="date-range-picker hidden" id="comingQualified-date-picker">
                <input type="text" class="date-input" id="comingQualified-start-date" placeholder="开始日期">
                <span>至</span>
                <input type="text" class="date-input" id="comingQualified-end-date" placeholder="结束日期">
                <button class="btn" id="comingQualified-apply">应用</button>
            </div>
            <div id="comingQualified" class="chart-content">
                <div class="loading">加载中...</div>
            </div>
        </div>

        <!-- 年累计进料（按项目） -->
        <div class="chart-container">
            <div class="chart-header">
                <div class="chart-title">年累计进料（按项目）</div>
                <div class="chart-controls">
                    <div class="project-selector">
                        <button class="selector-btn" id="yearComingProject-btn">
                            选择项目 ▼
                        </button>
                        <div class="selector-dropdown" id="yearComingProject-dropdown">
                            <!-- 项目选项将通过JS动态生成 -->
                        </div>
                    </div>
                    <div class="btn-group">
                        <button class="btn active" data-chart="yearComingProject" data-type="year">年</button>
                    </div>
                </div>
            </div>
            <div id="yearComingProject" class="chart-content">
                <div class="loading">加载中...</div>
            </div>
        </div>

        <!-- 累计进料/累计合格率（按项目） -->
        <div class="chart-container">
            <div class="chart-header">
                <div class="chart-title">累计进料/累计合格率（按项目）</div>
                <div class="chart-controls">
                    <div class="project-selector">
                        <button class="selector-btn" id="comingProject-btn">
                            选择项目 ▼
                        </button>
                        <div class="selector-dropdown" id="comingProject-dropdown">
                            <!-- 项目选项将通过JS动态生成 -->
                        </div>
                    </div>
                    <div class="btn-group">
                        <button class="btn active" data-chart="comingProject" data-type="day">日</button>
                        <button class="btn" data-chart="comingProject" data-type="week">周</button>
                        <button class="btn" data-chart="comingProject" data-type="month">月</button>
                        <button class="btn" data-chart="comingProject" data-type="custom">自定义</button>
                    </div>
                </div>
            </div>
            <div class="date-range-picker hidden" id="comingProject-date-picker">
                <input type="text" class="date-input" id="comingProject-start-date" placeholder="开始日期">
                <span>至</span>
                <input type="text" class="date-input" id="comingProject-end-date" placeholder="结束日期">
                <button class="btn" id="comingProject-apply">应用</button>
            </div>
            <div id="comingProject" class="chart-content">
                <div class="loading">加载中...</div>
            </div>
        </div>

        <!-- 供应商质量排行 -->
        <div class="supplier-rank-container">
            <div class="supplier-rank-header">
                <div class="supplier-rank-title">
                    <i class="fas fa-trophy"></i>
                    供应商质量排行
                </div>
                <div class="chart-controls">
                    <div class="project-selector">
                        <button class="selector-btn" id="supplier-rank-project-btn">
                            选择项目 ▼
                        </button>
                        <div class="selector-dropdown" id="supplier-rank-project-dropdown">
                            <!-- 项目选项将通过JS动态生成 -->
                        </div>
                    </div>
                    <div class="btn-group">
                        <button class="btn active" data-chart="supplierRank" data-type="day">日</button>
                        <button class="btn" data-chart="supplierRank" data-type="week">周</button>
                        <button class="btn" data-chart="supplierRank" data-type="month">月</button>
                        <button class="btn" data-chart="supplierRank" data-type="custom">自定义</button>
                    </div>
                </div>
            </div>

            <div class="date-range-picker hidden" id="supplier-rank-date-picker">
                <input type="text" class="date-input" id="supplier-rank-start-date" placeholder="开始日期">
                <span>至</span>
                <input type="text" class="date-input" id="supplier-rank-end-date" placeholder="结束日期">
                <button class="btn" id="supplier-rank-apply">应用</button>
            </div>

            <!-- 数据来源说明 -->
            <div class="data-source-note" id="supplier-data-note">
                <i class="fas fa-info-circle"></i>
                <span>显示最近7日/周/月数据或自定义数据</span>
            </div>

            <div class="supplier-rank-content">
                <!-- 供应商名称 -->
                <div class="supplier-rank-block">
                    <div class="supplier-rank-block-title">供应商名称</div>
                    <ul class="supplier-list" id="supplier-name-list">
                        <!-- 供应商名称数据将通过JS动态生成 -->
                    </ul>
                </div>

                <!-- 不良率 -->
                <div class="supplier-rank-block">
                    <div class="supplier-rank-block-title">不良率</div>
                    <ul class="supplier-list" id="defect-rate-list">
                        <!-- 不良率数据将通过JS动态生成 -->
                    </ul>
                </div>

                <!-- 进料批数 -->
                <div class="supplier-rank-block">
                    <div class="supplier-rank-block-title">进料批数</div>
                    <ul class="supplier-list" id="incoming-batches-list">
                        <!-- 进料批数数据将通过JS动态生成 -->
                    </ul>
                </div>

                <!-- 批退批数 -->
                <div class="supplier-rank-block">
                    <div class="supplier-rank-block-title">批退批数</div>
                    <ul class="supplier-list" id="reject-batches-list">
                        <!-- 批退批数数据将通过JS动态生成 -->
                    </ul>
                </div>
            </div>

            <div class="show-all-btn">
                <button class="btn-primary" id="show-all-suppliers-btn">
                    <i class="fas fa-list"></i>
                    显示全部供应商批退率数据
                </button>
            </div>
        </div>
    </div>

    <!-- 供应商详情模态框 -->
    <div class="modal" id="supplier-detail-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">供应商详情</div>
                <button class="modal-close" id="supplier-modal-close">&times;</button>
            </div>
            <div class="modal-body" id="supplier-detail-content">
                <!-- 供应商详情内容将通过JS动态生成 -->
            </div>
        </div>
    </div>

    <!-- 全部供应商模态框 -->
    <div class="modal" id="all-suppliers-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">全部供应商批退率数据</div>
                <button class="modal-close" id="all-suppliers-modal-close">&times;</button>
            </div>
            <div class="modal-body" id="all-suppliers-content">
                <!-- 全部供应商内容将通过JS动态生成 -->
            </div>
        </div>
    </div>
</body>

<script type="text/javascript">
    // 全局状态
    const viewState = {
        materialType: 'massProduction', // massProduction 或 rd
        selectedProjects: [], // 选中的项目

        // 统计卡片数据
        stats: {
            verifiedQty: 0,
            pendingInspection: 0,
            awaitingDisposition: 0,
            pendingMaintenance: 0,
            monthlyRejections: 0,
            inspectionDelay: 0
        },

        // 图表状态
        yearComingQualified: {
            type: 'year'
        },
        comingQualified: {
            type: 'day',
            startDate: null,
            endDate: null,
            projects: []
        },
        yearComingProject: {
            type: 'year',
            projects: []
        },
        comingProject: {
            type: 'day',
            startDate: null,
            endDate: null,
            projects: []
        },

        // 供应商排行状态
        supplierRank: {
            type: 'month', // 默认显示月数据
            startDate: null,
            endDate: null,
            projects: []
        }
    };

    // 项目选项配置
    const projectOptions = {
        massProduction: ['超乳', '超声刀', '电刀', '通用'],
        rd: ['机器人', '骨刀', '通用']
    };

    // 供应商数据（按批退率排序前5）
    const supplierData = [
        {
            id: 'A001',
            name: '供应商A',
            materialType: '电子元器件',
            defectRate: '0.8%',
            incomingBatches: 23441,
            rejectBatches: 3323,
            qualityRate: '99.2%',
            rank: 1
        },
        {
            id: 'B002',
            name: '供应商B',
            materialType: '塑料件',
            defectRate: '1.3%',
            incomingBatches: 442344,
            rejectBatches: 234,
            qualityRate: '98.7%',
            rank: 2
        },
        {
            id: 'C003',
            name: '供应商C',
            materialType: '金属加工件',
            defectRate: '4.7%',
            incomingBatches: 23455,
            rejectBatches: 23,
            qualityRate: '95.3%',
            rank: 3
        },
        {
            id: 'D004',
            name: '供应商D',
            materialType: '包装材料',
            defectRate: '8.5%',
            incomingBatches: 12345,
            rejectBatches: 456,
            qualityRate: '91.5%',
            rank: 4
        },
        {
            id: 'E005',
            name: '供应商E',
            materialType: '电子元器件',
            defectRate: '2.1%',
            incomingBatches: 56789,
            rejectBatches: 789,
            qualityRate: '97.9%',
            rank: 5
        }
    ];

    // 初始化ECharts实例
    const charts = {
        yearComingQualified: echarts.init(document.getElementById('yearComingQualified')),
        comingQualified: echarts.init(document.getElementById('comingQualified')),
        yearComingProject: echarts.init(document.getElementById('yearComingProject')),
        comingProject: echarts.init(document.getElementById('comingProject'))
    };

    // 初始化日期选择器
    function initDatePickers() {
        // 累计进料/累计合格率日期选择器
        flatpickr("#comingQualified-start-date", {
            dateFormat: "Y-m-d",
            onChange: function(selectedDates, dateStr) {
                viewState.comingQualified.startDate = dateStr;
            }
        });

        flatpickr("#comingQualified-end-date", {
            dateFormat: "Y-m-d",
            onChange: function(selectedDates, dateStr) {
                viewState.comingQualified.endDate = dateStr;
            }
        });

        // 累计进料/累计合格率（按项目）日期选择器
        flatpickr("#comingProject-start-date", {
            dateFormat: "Y-m-d",
            onChange: function(selectedDates, dateStr) {
                viewState.comingProject.startDate = dateStr;
            }
        });

        flatpickr("#comingProject-end-date", {
            dateFormat: "Y-m-d",
            onChange: function(selectedDates, dateStr) {
                viewState.comingProject.endDate = dateStr;
            }
        });

        // 供应商排行日期选择器
        flatpickr("#supplier-rank-start-date", {
            dateFormat: "Y-m-d",
            onChange: function(selectedDates, dateStr) {
                viewState.supplierRank.startDate = dateStr;
            }
        });

        flatpickr("#supplier-rank-end-date", {
            dateFormat: "Y-m-d",
            onChange: function(selectedDates, dateStr) {
                viewState.supplierRank.endDate = dateStr;
            }
        });
    }

    // 设置默认日期范围
    function setDefaultDateRange() {
        const endDate = new Date();
        const startDate = new Date();

        // 根据类型设置不同的默认范围
        const setRange = (days) => {
            const start = new Date();
            start.setDate(start.getDate() - days);

            return {
                start: start.toISOString().split('T')[0],
                end: endDate.toISOString().split('T')[0]
            };
        };

        // 设置默认值
        const dayRange = setRange(1);
        const weekRange = setRange(7);
        const monthRange = setRange(30);

        // 更新输入框
        document.getElementById('comingQualified-start-date').value = dayRange.start;
        document.getElementById('comingQualified-end-date').value = dayRange.end;

        document.getElementById('comingProject-start-date').value = dayRange.start;
        document.getElementById('comingProject-end-date').value = dayRange.end;

        document.getElementById('supplier-rank-start-date').value = monthRange.start;
        document.getElementById('supplier-rank-end-date').value = monthRange.end;

        // 更新状态
        viewState.comingQualified.startDate = dayRange.start;
        viewState.comingQualified.endDate = dayRange.end;

        viewState.comingProject.startDate = dayRange.start;
        viewState.comingProject.endDate = dayRange.end;

        viewState.supplierRank.startDate = monthRange.start;
        viewState.supplierRank.endDate = monthRange.end;
    }

    // 更新项目选择器
    function updateProjectSelectors() {
        const projects = projectOptions[viewState.materialType];

        // 更新所有项目选择器
        ['comingQualified-project', 'yearComingProject', 'comingProject', 'supplier-rank-project'].forEach(selectorId => {
            const dropdown = document.getElementById(`${selectorId}-dropdown`);
            if (dropdown) {
                dropdown.innerHTML = '';

                projects.forEach(project => {
                    const option = document.createElement('div');
                    option.className = 'selector-option';
                    option.innerHTML = `
                        <input type="checkbox" id="${selectorId}-${project}" value="${project}" checked>
                        <label for="${selectorId}-${project}">${project}</label>
                    `;
                    dropdown.appendChild(option);
                });

                // 添加确定按钮
                const applyBtn = document.createElement('button');
                applyBtn.className = 'btn';
                applyBtn.textContent = '确定';
                applyBtn.style.width = '100%';
                applyBtn.style.marginTop = '10px';
                applyBtn.onclick = function() {
                    updateChartBySelector(selectorId);
                    dropdown.style.display = 'none';
                };
                dropdown.appendChild(applyBtn);

                // 更新选中状态
                if (selectorId.includes('comingQualified')) {
                    viewState.comingQualified.projects = [...projects];
                } else if (selectorId.includes('yearComingProject')) {
                    viewState.yearComingProject.projects = [...projects];
                } else if (selectorId.includes('comingProject')) {
                    viewState.comingProject.projects = [...projects];
                } else if (selectorId.includes('supplier-rank')) {
                    viewState.supplierRank.projects = [...projects];
                }
            }
        });
    }

    // 根据选择器更新图表
    function updateChartBySelector(selectorId) {
        const projects = [];
        const checkboxes = document.querySelectorAll(`#${selectorId}-dropdown input[type="checkbox"]:checked`);
        checkboxes.forEach(cb => projects.push(cb.value));

        if (selectorId.includes('comingQualified')) {
            viewState.comingQualified.projects = projects;
            loadComingQualifiedChart();
        } else if (selectorId.includes('yearComingProject')) {
            viewState.yearComingProject.projects = projects;
            loadYearComingProjectChart();
        } else if (selectorId.includes('comingProject')) {
            viewState.comingProject.projects = projects;
            loadComingProjectChart();
        } else if (selectorId.includes('supplier-rank')) {
            viewState.supplierRank.projects = projects;
            renderSupplierRankData();
        }
    }

    // 更新数据来源说明
    function updateDataSourceNote() {
        const noteElement = document.getElementById('supplier-data-note');
        let noteText = '';

        switch (viewState.supplierRank.type) {
            case 'day':
                noteText = '显示最近1日数据';
                break;
            case 'week':
                noteText = '显示最近7日数据';
                break;
            case 'month':
                noteText = '显示最近30日数据';
                break;
            case 'custom':
                if (viewState.supplierRank.startDate && viewState.supplierRank.endDate) {
                    noteText = `显示${viewState.supplierRank.startDate}至${viewState.supplierRank.endDate}数据`;
                } else {
                    noteText = '显示自定义时间范围数据';
                }
                break;
            default:
                noteText = '显示最近30日数据';
        }

        noteElement.innerHTML = `<i class="fas fa-info-circle"></i><span>${noteText}</span>`;
    }

    // 渲染供应商排行数据
    function renderSupplierRankData() {
        // 渲染供应商名称列表
        const nameList = document.getElementById('supplier-name-list');
        nameList.innerHTML = '';

        supplierData.forEach((supplier, index) => {
            const li = document.createElement('li');
            li.className = 'supplier-item';
            li.innerHTML = `
                <span class="supplier-rank-number">${index + 1}</span>
                <span class="supplier-name" data-supplier-id="${supplier.id}">${supplier.name}</span>
            `;
            nameList.appendChild(li);
        });

        // 渲染不良率列表
        const defectRateList = document.getElementById('defect-rate-list');
        defectRateList.innerHTML = '';

        supplierData.forEach((supplier, index) => {
            const li = document.createElement('li');
            li.className = 'supplier-item';
            li.innerHTML = `
                <span class="supplier-rank-number">${index + 1}</span>
                <span class="supplier-value defect-rate">${supplier.defectRate}</span>
            `;
            defectRateList.appendChild(li);
        });

        // 渲染进料批数列表
        const incomingBatchesList = document.getElementById('incoming-batches-list');
        incomingBatchesList.innerHTML = '';

        supplierData.forEach((supplier, index) => {
            const li = document.createElement('li');
            li.className = 'supplier-item';
            li.innerHTML = `
                <span class="supplier-rank-number">${index + 1}</span>
                <span class="supplier-value incoming-batches">${supplier.incomingBatches.toLocaleString()}</span>
            `;
            incomingBatchesList.appendChild(li);
        });

        // 渲染批退批数列表
        const rejectBatchesList = document.getElementById('reject-batches-list');
        rejectBatchesList.innerHTML = '';

        supplierData.forEach((supplier, index) => {
            const li = document.createElement('li');
            li.className = 'supplier-item';
            li.innerHTML = `
                <span class="supplier-rank-number">${index + 1}</span>
                <span class="supplier-value reject-batches">${supplier.rejectBatches.toLocaleString()}</span>
            `;
            rejectBatchesList.appendChild(li);
        });

        // 更新数据来源说明
        updateDataSourceNote();
    }

    // 显示供应商详情
    function showSupplierDetail(supplierId) {
        const supplier = supplierData.find(s => s.id === supplierId);
        if (!supplier) return;

        const modal = document.getElementById('supplier-detail-modal');
        const content = document.getElementById('supplier-detail-content');

        content.innerHTML = `
            <div style="margin-bottom: 20px;">
                <h3 style="margin-bottom: 10px;">${supplier.name} - 质量分析报告</h3>
                <p style="color: #666; margin-bottom: 15px;">物料类型：${supplier.materialType}</p>
            </div>

            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 30px;">
                <div style="background: #f9f9f9; padding: 15px; border-radius: 6px;">
                    <h4 style="margin-bottom: 10px; color: #333;">质量指标</h4>
                    <p>合格率：<strong style="color: #1abc9c;">${supplier.qualityRate}</strong></p>
                    <p>不良率：<strong style="color: #e74c3c;">${supplier.defectRate}</strong></p>
                </div>
                <div style="background: #f9f9f9; padding: 15px; border-radius: 6px;">
                    <h4 style="margin-bottom: 10px; color: #333;">进料统计</h4>
                    <p>进料批数：<strong style="color: #3498db;">${supplier.incomingBatches.toLocaleString()}</strong></p>
                    <p>批退批数：<strong style="color: #f39c12;">${supplier.rejectBatches.toLocaleString()}</strong></p>
                </div>
            </div>

            <h4 style="margin-bottom: 15px;">近期异常记录</h4>
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr>
                        <th style="padding: 10px; background: #f5f5f5; text-align: left;">日期</th>
                        <th style="padding: 10px; background: #f5f5f5; text-align: left;">异常类型</th>
                        <th style="padding: 10px; background: #f5f5f5; text-align: left;">处理状态</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td style="padding: 10px; border-bottom: 1px solid #eee;">2023-06-15</td>
                        <td style="padding: 10px; border-bottom: 1px solid #eee;">外观缺陷</td>
                        <td style="padding: 10px; border-bottom: 1px solid #eee;"><span style="color: #f39c12;">处理中</span></td>
                    </tr>
                    <tr>
                        <td style="padding: 10px; border-bottom: 1px solid #eee;">2023-06-10</td>
                        <td style="padding: 10px; border-bottom: 1px solid #eee;">尺寸超差</td>
                        <td style="padding: 10px; border-bottom: 1px solid #eee;"><span style="color: #1abc9c;">已解决</span></td>
                    </tr>
                </tbody>
            </table>
        `;

        modal.classList.add('active');
    }

    // 显示全部供应商数据
    function showAllSuppliers() {
        const modal = document.getElementById('all-suppliers-modal');
        const content = document.getElementById('all-suppliers-content');

        let tableHtml = `
            <div style="margin-bottom: 20px;">
                <h3 style="margin-bottom: 10px;">全部供应商批退率数据</h3>
                <p style="color: #666;">统计时间：${new Date().toLocaleDateString()}</p>
            </div>

            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr>
                        <th style="padding: 12px; background: #f5f5f5; text-align: left;">排名</th>
                        <th style="padding: 12px; background: #f5f5f5; text-align: left;">供应商名称</th>
                        <th style="padding: 12px; background: #f5f5f5; text-align: left;">物料类型</th>
                        <th style="padding: 12px; background: #f5f5f5; text-align: left;">合格率</th>
                        <th style="padding: 12px; background: #f5f5f5; text-align: left;">不良率</th>
                        <th style="padding: 12px; background: #f5f5f5; text-align: left;">进料批数</th>
                        <th style="padding: 12px; background: #f5f5f5; text-align: left;">批退批数</th>
                    </tr>
                </thead>
                <tbody>
        `;

        // 假设有更多供应商数据
        const allSuppliers = [
            ...supplierData,
            {
                id: 'F006',
                name: '供应商F',
                materialType: '电子元器件',
                defectRate: '1.5%',
                incomingBatches: 34567,
                rejectBatches: 234,
                qualityRate: '98.5%',
                rank: 6
            },
            {
                id: 'G007',
                name: '供应商G',
                materialType: '塑料件',
                defectRate: '2.3%',
                incomingBatches: 45678,
                rejectBatches: 345,
                qualityRate: '97.7%',
                rank: 7
            },
            {
                id: 'H008',
                name: '供应商H',
                materialType: '金属加工件',
                defectRate: '3.8%',
                incomingBatches: 56789,
                rejectBatches: 456,
                qualityRate: '96.2%',
                rank: 8
            }
        ];

        allSuppliers.forEach(supplier => {
            tableHtml += `
                <tr>
                    <td style="padding: 10px; border-bottom: 1px solid #eee;">${supplier.rank}</td>
                    <td style="padding: 10px; border-bottom: 1px solid #eee;">${supplier.name}</td>
                    <td style="padding: 10px; border-bottom: 1px solid #eee;">${supplier.materialType}</td>
                    <td style="padding: 10px; border-bottom: 1px solid #eee; color: #1abc9c;">${supplier.qualityRate}</td>
                    <td style="padding: 10px; border-bottom: 1px solid #eee; color: #e74c3c;">${supplier.defectRate}</td>
                    <td style="padding: 10px; border-bottom: 1px solid #eee;">${supplier.incomingBatches.toLocaleString()}</td>
                    <td style="padding: 10px; border-bottom: 1px solid #eee;">${supplier.rejectBatches.toLocaleString()}</td>
                </tr>
            `;
        });

        tableHtml += `
                </tbody>
            </table>

            <div style="margin-top: 20px; padding: 15px; background: #f9f9f9; border-radius: 6px;">
                <h4 style="margin-bottom: 10px;">统计说明</h4>
                <ul style="color: #666; font-size: 14px;">
                    <li>数据统计范围：${viewState.supplierRank.startDate || '最近30日'} 至 ${viewState.supplierRank.endDate || '今日'}</li>
                    <li>排名依据：按批退率从低到高排序（批退率越低排名越靠前）</li>
                    <li>数据更新时间：${new Date().toLocaleString()}</li>
                </ul>
            </div>
        `;

        content.innerHTML = tableHtml;
        modal.classList.add('active');
    }

    // 事件处理
    function initEventListeners() {
        // 物料类型切换
        document.getElementById('mass-production-btn').addEventListener('click', function() {
            if (viewState.materialType !== 'massProduction') {
                document.getElementById('mass-production-btn').classList.add('active');
                document.getElementById('rd-btn').classList.remove('active');
                viewState.materialType = 'massProduction';
                updateProjectSelectors();
                reloadAllData();
            }
        });

        document.getElementById('rd-btn').addEventListener('click', function() {
            if (viewState.materialType !== 'rd') {
                document.getElementById('rd-btn').classList.add('active');
                document.getElementById('mass-production-btn').classList.remove('active');
                viewState.materialType = 'rd';
                updateProjectSelectors();
                reloadAllData();
            }
        });

        // 统计卡片点击事件
        document.querySelectorAll('.stats-container li').forEach(li => {
            li.addEventListener('click', function() {
                const api = this.getAttribute('data-api');
                const title = this.textContent.split('：')[0];
                alert(`显示${title}的详情数据\nAPI: ${api}`);
            });
        });

        // 项目选择器点击事件
        document.querySelectorAll('.selector-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const selectorId = this.id.replace('-btn', '');
                const dropdown = document.getElementById(`${selectorId}-dropdown`);
                if (dropdown) {
                    dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
                }
            });
        });

        // 图表类型切换
        document.querySelectorAll('.btn[data-chart][data-type]').forEach(btn => {
            btn.addEventListener('click', function() {
                const chartId = this.getAttribute('data-chart');
                const type = this.getAttribute('data-type');

                // 更新按钮状态
                const parent = this.parentNode;
                parent.querySelectorAll('.btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');

                // 更新视图状态
                viewState[chartId].type = type;

                // 显示/隐藏日期选择器
                if (type === 'custom') {
                    document.getElementById(`${chartId}-date-picker`).classList.remove('hidden');
                } else {
                    document.getElementById(`${chartId}-date-picker`).classList.add('hidden');
                    // 如果是供应商排行，更新显示
                    if (chartId === 'supplierRank') {
                        updateDataSourceNote();
                        renderSupplierRankData();
                    }
                }
            });
        });

        // 日期范围应用按钮
        document.getElementById('comingQualified-apply').addEventListener('click', function() {
            if (!viewState.comingQualified.startDate || !viewState.comingQualified.endDate) {
                alert('请选择开始日期和结束日期');
                return;
            }
            document.getElementById('comingQualified-date-picker').classList.add('hidden');
            loadComingQualifiedChart();
        });

        document.getElementById('comingProject-apply').addEventListener('click', function() {
            if (!viewState.comingProject.startDate || !viewState.comingProject.endDate) {
                alert('请选择开始日期和结束日期');
                return;
            }
            document.getElementById('comingProject-date-picker').classList.add('hidden');
            loadComingProjectChart();
        });

        document.getElementById('supplier-rank-apply').addEventListener('click', function() {
            if (!viewState.supplierRank.startDate || !viewState.supplierRank.endDate) {
                alert('请选择开始日期和结束日期');
                return;
            }
            document.getElementById('supplier-rank-date-picker').classList.add('hidden');
            updateDataSourceNote();
            renderSupplierRankData();
        });

        // 显示全部供应商按钮
        document.getElementById('show-all-suppliers-btn').addEventListener('click', showAllSuppliers);

        // 供应商名称点击事件（委托事件处理）
        document.addEventListener('click', function(e) {
            // 供应商名称点击
            if (e.target.classList.contains('supplier-name')) {
                const supplierId = e.target.getAttribute('data-supplier-id');
                showSupplierDetail(supplierId);
            }

            // 异常表格中的供应商名称点击
            if (e.target.classList.contains('supplier-name-cell')) {
                const supplierName = e.target.getAttribute('data-supplier-name');
                const supplier = supplierData.find(s => s.name === supplierName);
                if (supplier) {
                    showSupplierDetail(supplier.id);
                }
            }
        });

        // 模态框关闭按钮
        document.getElementById('supplier-modal-close').addEventListener('click', function() {
            document.getElementById('supplier-detail-modal').classList.remove('active');
        });

        document.getElementById('all-suppliers-modal-close').addEventListener('click', function() {
            document.getElementById('all-suppliers-modal').classList.remove('active');
        });

        // 点击模态框背景关闭
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', function(e) {
                if (e.target === this) {
                    this.classList.remove('active');
                }
            });
        });
    }

    // 重新加载所有数据
    function reloadAllData() {
        // 这里可以调用API加载数据
        renderSupplierRankData();
    }

    // 初始化
    document.addEventListener('DOMContentLoaded', function() {
        initDatePickers();
        setDefaultDateRange();
        updateProjectSelectors();
        initEventListeners();
        renderSupplierRankData();
        updateDataSourceNote();
    });

    // 窗口大小变化时调整图表
    window.addEventListener('resize', function() {
        Object.values(charts).forEach(chart => chart.resize());
    });
</script>
</html>